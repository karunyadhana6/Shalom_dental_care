<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Portal - Shalom Dental Care</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-blue: #0EA5E9;
            --primary-blue-dark: #0284C7;
            --primary-blue-light: #7DD3FC;
            --secondary-teal: #14b8a6;
            --accent-green: #10b981;
            --accent-purple: #8b5cf6;
            --accent-pink: #ec4899;
            --light-blue: rgba(224, 242, 254, 0.8);
            --medium-gray: #64748b;
            --dark-gray: #334155;
            --charcoal: #1e293b;
            --silver: #94a3b8;
            --silver-light: #cbd5e1;
            --white: #ffffff;
            --off-white: #f8fafc;
            --glass-bg: rgba(255, 255, 255, 0.9);
            --glass-bg-solid: rgba(255, 255, 255, 0.98);
            --glass-border: rgba(148, 163, 184, 0.3);
            --glass-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(180deg, #f0f9ff 0%, #ffffff 50%, #f8fafc 100%);
            background-attachment: fixed;
            min-height: 100vh;
            position: relative;
            color: var(--charcoal);
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 20%, rgba(14, 165, 233, 0.08) 0%, transparent 40%),
                radial-gradient(circle at 80% 80%, rgba(148, 163, 184, 0.1) 0%, transparent 40%),
                radial-gradient(circle at 50% 50%, rgba(14, 165, 233, 0.03) 0%, transparent 60%);
            pointer-events: none;
            z-index: 0;
        }

        /* Clean Header */
        .admin-header {
            background: var(--white);
            border-bottom: 1px solid var(--silver-light);
            color: var(--charcoal);
            padding: 0.75rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .admin-header h1 {
            font-size: 1.35rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: var(--charcoal);
            font-weight: 700;
        }

        .admin-header h1 .header-logo {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            object-fit: cover;
            box-shadow: 0 2px 8px rgba(14, 165, 233, 0.2);
        }

        .admin-header h1 .header-brand {
            display: flex;
            flex-direction: column;
            line-height: 1.2;
        }

        .admin-header h1 .header-brand small {
            font-size: 0.65rem;
            font-weight: 500;
            color: var(--primary-blue);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .admin-header h1 i {
            font-size: 1.75rem;
            color: var(--primary-blue);
        }

        .header-actions {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        .header-actions button {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-secondary {
            background: var(--off-white);
            border: 1px solid var(--silver-light);
            color: var(--charcoal);
        }

        .btn-secondary:hover {
            background: var(--white);
            border-color: var(--primary-blue);
            color: var(--primary-blue);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(14, 165, 233, 0.15);
        }

        .btn-danger {
            background: #ef4444;
            border: 1px solid #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
        }

        .btn-success {
            background: #10b981;
            border: 1px solid #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        .status-badge {
            background: rgba(16, 185, 129, 0.15);
            border: 1px solid rgba(16, 185, 129, 0.3);
            color: #059669;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Main Content */
        .admin-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
            position: relative;
            z-index: 1;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--white);
            border: 1px solid var(--silver-light);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            border-radius: 16px 16px 0 0;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
            border-color: var(--primary-blue-light);
        }

        .stat-card.pending::before {
            background: linear-gradient(90deg, #f59e0b, #fbbf24);
        }

        .stat-card.confirmed::before {
            background: linear-gradient(90deg, #10b981, #34d399);
        }

        .stat-card.today::before {
            background: linear-gradient(90deg, var(--primary-blue), var(--primary-blue-light));
        }

        .stat-card.total::before {
            background: linear-gradient(90deg, #8b5cf6, #a78bfa);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--charcoal);
            margin-bottom: 0.5rem;
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--medium-gray);
            font-weight: 500;
        }

        /* Search and Controls - Clean Style */
        .controls-section {
            background: var(--white);
            border: 1px solid var(--silver-light);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }

        .search-box {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .search-box input {
            flex: 1;
            padding: 0.875rem 1.25rem;
            background: var(--off-white);
            border: 1px solid var(--silver-light);
            border-radius: 12px;
            font-size: 1rem;
            color: var(--charcoal);
            transition: all 0.3s ease;
        }

        .search-box input::placeholder {
            color: var(--silver);
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--primary-blue);
            background: var(--white);
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
        }
        .quick-actions-row {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .quick-action-btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            padding: 1.1rem 1.5rem;
            border: 2px solid transparent;
            border-radius: 16px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .quick-action-btn i {
            font-size: 1.2rem;
        }

        .quick-action-btn.appointments-btn {
            background: linear-gradient(135deg, #0EA5E9, #0284C7);
            color: white;
            box-shadow: 0 4px 15px rgba(14, 165, 233, 0.3);
        }

        .quick-action-btn.appointments-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(14, 165, 233, 0.45);
        }

        .quick-action-btn.appointments-btn.active {
            box-shadow: 0 2px 8px rgba(14, 165, 233, 0.3), inset 0 0 0 3px rgba(255,255,255,0.3);
            transform: translateY(-1px);
        }

        .quick-action-btn.calendar-quick-btn {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .quick-action-btn.calendar-quick-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.45);
        }

        .quick-action-btn.calendar-quick-btn.active {
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3), inset 0 0 0 3px rgba(255,255,255,0.3);
            transform: translateY(-1px);
        }

        .quick-action-btn.analytics-btn {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
        }

        .quick-action-btn.analytics-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.45);
        }

        .quick-action-btn.analytics-btn.active {
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3), inset 0 0 0 3px rgba(255,255,255,0.3);
            transform: translateY(-1px);
        }

        .quick-action-btn.feedback-btn {
            background: linear-gradient(135deg, #f59e0b, #f97316);
            color: white;
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
        }

        .quick-action-btn.feedback-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(245, 158, 11, 0.45);
        }

        .quick-action-btn.feedback-btn.active {
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3), inset 0 0 0 3px rgba(255,255,255,0.3);
            transform: translateY(-1px);
        }

        .quick-action-btn .btn-badge {
            background: rgba(255,255,255,0.25);
            padding: 0.15rem 0.55rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            margin-left: 0.25rem;
        }

        /* Filter Tabs - Clean Style */
        .filter-tabs {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .filter-tab {
            padding: 0.6rem 1.2rem;
            background: var(--off-white);
            border: 1px solid var(--silver-light);
            border-radius: 25px;
            cursor: pointer;
            font-weight: 500;
            color: var(--medium-gray);
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .filter-tab.active {
            background: var(--primary-blue);
            color: var(--white);
            border-color: var(--primary-blue);
            box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);
        }

        .filter-tab:hover:not(.active) {
            background: var(--white);
            border-color: var(--primary-blue);
            color: var(--primary-blue);
            transform: translateY(-2px);
        }

        /* Content Area - Clean Style */
        .content-area {
            background: var(--white);
            border: 1px solid var(--silver-light);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            min-height: 500px;
        }

        /* Appointments List */
        .appointments-grid {
            display: grid;
            gap: 1rem;
        }

        .appointment-card {
            background: var(--white);
            border: 1px solid var(--silver-light);
            border-radius: 16px;
            padding: 1.5rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .appointment-card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 5px;
            background: var(--silver);
        }

        .appointment-card:hover {
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
            transform: translateY(-4px);
            border-color: var(--primary-blue-light);
        }

        .appointment-card.pending::before {
            background: linear-gradient(180deg, #f59e0b, #fbbf24);
        }

        .appointment-card.confirmed::before {
            background: linear-gradient(180deg, #10b981, #34d399);
        }

        .appointment-card.completed::before {
            background: linear-gradient(180deg, #6366f1, #818cf8);
        }

        .appointment-card.cancelled::before {
            background: linear-gradient(180deg, #ef4444, #f87171);
        }

        .appointment-card.cancelled {
            opacity: 0.7;
        }

        .appointment-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }

        .appointment-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--charcoal);
        }

        .appointment-status {
            padding: 0.35rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            color: white;
        }

        .appointment-status.pending {
            background: #f59e0b;
        }

        .appointment-status.confirmed {
            background: #10b981;
        }

        .appointment-status.completed {
            background: var(--primary-blue);
        }

        .appointment-status.cancelled {
            background: #ef4444;
        }

        .appointment-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.75rem;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            color: var(--charcoal);
        }

        .appointment-details div {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: rgba(99, 102, 241, 0.05);
            padding: 0.5rem 0.75rem;
            border-radius: 10px;
        }

        .appointment-details i {
            color: var(--primary-blue);
            width: 20px;
        }

        .appointment-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            padding-top: 1rem;
            border-top: 1px solid rgba(0, 0, 0, 0.05);
        }

        .appointment-actions button {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.35rem;
        }

        .btn-confirm {
            background: linear-gradient(135deg, #10b981, #34d399);
            color: white;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .btn-confirm:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }

        .btn-complete {
            background: linear-gradient(135deg, #6366f1, #818cf8);
            color: white;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
        }

        .btn-complete:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
        }

        .btn-reschedule {
            background: linear-gradient(135deg, #f59e0b, #fbbf24);
            color: white;
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
        }

        .btn-reschedule:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(245, 158, 11, 0.4);
        }

        .btn-cancel {
            background: linear-gradient(135deg, #ef4444, #f87171);
            color: white;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }

        .btn-cancel:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
        }

        .appointment-meta {
            font-size: 0.8rem;
            color: var(--medium-gray);
            margin-top: 0.75rem;
        }

        /* Billing Calculator */
        .billing-calculator {
            margin-top: 1rem;
            padding: 1rem 1.25rem;
            background: linear-gradient(135deg, #f0f9ff, #f8fafc);
            border: 1px solid #e0e7ff;
            border-radius: 12px;
        }

        .billing-calculator h5 {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--primary-blue-dark);
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .billing-calculator h5 i {
            font-size: 0.9rem;
        }

        .billing-fields {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.75rem;
            align-items: end;
        }

        .billing-field {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }

        .billing-field label {
            font-size: 0.72rem;
            font-weight: 600;
            color: var(--medium-gray);
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .billing-field input {
            padding: 0.55rem 0.75rem;
            border: 1.5px solid #d1d5db;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--charcoal);
            background: var(--white);
            transition: all 0.2s ease;
            text-align: right;
        }

        .billing-field input:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
        }

        .billing-field input::placeholder {
            color: #cbd5e1;
            font-weight: 400;
        }

        .billing-field.total-field input {
            background: linear-gradient(135deg, #0EA5E9, #0284C7);
            color: white;
            font-weight: 700;
            font-size: 1rem;
            border: none;
            cursor: default;
        }

        .billing-field.total-field label {
            color: var(--primary-blue-dark);
            font-weight: 700;
        }

        .billing-submit-row {
            display: flex;
            justify-content: flex-end;
            margin-top: 0.75rem;
        }

        .btn-submit-billing {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.55rem 1.25rem;
            font-size: 0.8rem;
            font-weight: 600;
            color: #fff;
            background: linear-gradient(135deg, #10b981, #059669);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.25s ease;
            box-shadow: 0 2px 6px rgba(16, 185, 129, 0.25);
        }

        .btn-submit-billing:hover {
            background: linear-gradient(135deg, #059669, #047857);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.35);
            transform: translateY(-1px);
        }

        .btn-submit-billing:active {
            transform: translateY(0);
        }

        .btn-submit-billing:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-submit-billing .spinner {
            display: none;
            width: 14px;
            height: 14px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .billing-fields {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Calendar Styles */
        /* Calendar Styles - Clean Style */
        .calendar-container {
            background: var(--white);
            border: 1px solid var(--silver-light);
            border-radius: 16px;
            padding: 1.5rem;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--silver-light);
        }

        .calendar-header h3 {
            font-size: 1.3rem;
            color: var(--primary-blue);
        }

        .calendar-nav {
            display: flex;
            gap: 0.5rem;
        }

        .calendar-nav button {
            padding: 0.5rem 1rem;
            background: var(--off-white);
            border: 1px solid var(--silver-light);
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--primary-blue);
            transition: all 0.3s ease;
        }

        .calendar-nav button:hover {
            background: var(--primary-blue);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);
        }

        .calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            background: linear-gradient(135deg, rgba(14, 165, 233, 0.1), rgba(125, 211, 252, 0.1));
            border-radius: 12px 12px 0 0;
            overflow: hidden;
        }

        .calendar-weekdays div {
            text-align: center;
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--primary-blue);
            padding: 1rem 0;
            border-right: 1px solid rgba(14, 165, 233, 0.1);
        }

        .calendar-weekdays div:last-child {
            border-right: none;
        }

        .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            background: var(--silver-light);
            border: 1px solid var(--silver-light);
            border-radius: 0 0 12px 12px;
        }

        .calendar-day {
            min-height: 100px;
            padding: 0.75rem;
            background: var(--white);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .calendar-day:hover {
            background: var(--off-white);
            transform: scale(1.02);
            z-index: 1;
            box-shadow: 0 4px 16px rgba(14, 165, 233, 0.15);
        }

        .calendar-day.empty {
            background: var(--off-white);
            cursor: default;
        }

        .calendar-day.empty:hover {
            transform: none;
            box-shadow: none;
        }

        .calendar-day.today {
            background: rgba(14, 165, 233, 0.08);
            border: 2px solid var(--primary-blue);
        }

        .calendar-day.has-appointments {
            background: linear-gradient(135deg, rgba(254, 252, 232, 0.8), rgba(254, 249, 195, 0.8));
        }

        .calendar-day.today.has-appointments {
            background: linear-gradient(135deg, rgba(236, 253, 245, 0.9), rgba(209, 250, 229, 0.9));
            border: 2px solid #10b981;
        }

        .day-number {
            font-weight: 700;
            font-size: 1rem;
            color: var(--charcoal);
            display: block;
            margin-bottom: 0.5rem;
        }

        .calendar-day.today .day-number {
            color: var(--primary-blue);
            text-shadow: 0 1px 3px rgba(99, 102, 241, 0.2);
        }

        .appointment-count {
            font-size: 0.75rem;
            color: var(--medium-gray);
            margin-bottom: 0.25rem;
        }

        .calendar-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 3px;
        }

        .calendar-badge {
            font-size: 0.65rem;
            font-weight: 600;
            padding: 3px 8px;
            border-radius: 10px;
            color: white;
        }

        .calendar-badge.pending {
            background: linear-gradient(135deg, #f59e0b, #fbbf24);
        }

        .calendar-badge.confirmed {
            background: linear-gradient(135deg, #10b981, #34d399);
        }

        .calendar-badge.completed {
            background: linear-gradient(135deg, #6366f1, #818cf8);
        }

        .calendar-badge.cancelled {
            background: linear-gradient(135deg, #ef4444, #f87171);
        }

        /* Day Detail Modal - Clean Style */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(30, 41, 59, 0.5);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: var(--white);
            border: 1px solid var(--silver-light);
            border-radius: 20px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--silver-light);
        }

        .modal-header h3 {
            color: var(--primary-blue);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .modal-close {
            background: var(--off-white);
            border: 1px solid var(--silver-light);
            font-size: 1.25rem;
            cursor: pointer;
            color: var(--medium-gray);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background: var(--primary-blue);
            color: white;
            border-color: var(--primary-blue);
        }

        .day-appointment {
            background: var(--off-white);
            border: 1px solid var(--silver-light);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            position: relative;
            overflow: hidden;
        }

        .day-appointment::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: #6b7280;
        }

        .day-appointment.pending::before {
            background: linear-gradient(180deg, #f59e0b, #fbbf24);
        }

        .day-appointment.confirmed::before {
            background: linear-gradient(180deg, #10b981, #34d399);
        }

        .day-appointment.completed::before {
            background: linear-gradient(180deg, #6366f1, #818cf8);
        }

        .day-appointment.cancelled::before {
            background: linear-gradient(180deg, #ef4444, #f87171);
        }

        .day-appointment.cancelled {
            opacity: 0.7;
        }

        /* Notification - Clean Style */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            border: 1px solid transparent;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            z-index: 2000;
            font-weight: 500;
            color: white;
            transform: translateX(150%);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: linear-gradient(135deg, #10b981, #34d399);
            border-color: #10b981;
        }

        .notification.error {
            background: linear-gradient(135deg, #ef4444, #f87171);
            border-color: #ef4444;
        }

        .notification.info {
            background: linear-gradient(135deg, var(--primary-blue), var(--primary-blue-light));
            border-color: var(--primary-blue);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--medium-gray);
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1rem;
            color: var(--silver);
        }

        .empty-state h3 {
            margin-bottom: 0.5rem;
            color: var(--charcoal);
        }

        /* ==================== LOGIN SCREEN - PROFESSIONAL SPLIT LAYOUT ==================== */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            z-index: 3000;
            background: #f0f9ff;
        }

        .login-screen::before {
            display: none;
        }

        /* Left Panel — Hero Image */
        .login-hero {
            flex: 1.2;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            background: #0c4a6e;
        }

        .login-hero-img {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center 30%;
            filter: brightness(0.65) saturate(1.1);
        }

        .login-hero-overlay {
            position: absolute;
            inset: 0;
            background: linear-gradient(
                180deg,
                rgba(2, 132, 199, 0.35) 0%,
                rgba(12, 74, 110, 0.55) 50%,
                rgba(7, 28, 46, 0.85) 100%
            );
        }

        .login-hero-content {
            position: relative;
            z-index: 2;
            padding: 3rem 3.5rem;
            color: white;
        }

        .login-hero-content .hero-tagline {
            font-size: 2.2rem;
            font-weight: 700;
            line-height: 1.25;
            margin-bottom: 1rem;
            text-shadow: 0 2px 20px rgba(0,0,0,0.3);
        }

        .login-hero-content .hero-tagline span {
            color: var(--primary-blue-light);
        }

        .login-hero-content .hero-subtitle {
            font-size: 1rem;
            font-weight: 400;
            opacity: 0.85;
            line-height: 1.6;
            max-width: 420px;
        }

        .login-hero-badges {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }

        .login-hero-badge {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: rgba(255,255,255,0.12);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255,255,255,0.18);
            padding: 0.5rem 1rem;
            border-radius: 30px;
            font-size: 0.8rem;
            font-weight: 500;
            color: rgba(255,255,255,0.95);
        }

        .login-hero-badge i {
            font-size: 0.85rem;
            color: var(--primary-blue-light);
        }

        /* Right Panel — Login Form */
        .login-form-panel {
            flex: 0.8;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 3rem;
            background: var(--white);
            position: relative;
            overflow-y: auto;
        }

        .login-form-panel::before {
            content: '';
            position: absolute;
            top: -150px;
            right: -150px;
            width: 350px;
            height: 350px;
            background: radial-gradient(circle, rgba(14, 165, 233, 0.06) 0%, transparent 70%);
            border-radius: 50%;
            pointer-events: none;
        }

        .login-form-panel::after {
            content: '';
            position: absolute;
            bottom: -100px;
            left: -100px;
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, rgba(99, 102, 241, 0.05) 0%, transparent 70%);
            border-radius: 50%;
            pointer-events: none;
        }

        .login-box {
            width: 100%;
            max-width: 380px;
            position: relative;
            z-index: 1;
            background: transparent;
            border: none;
            padding: 0;
            border-radius: 0;
            box-shadow: none;
            text-align: center;
        }

        .login-logo-wrapper {
            margin-bottom: 1.5rem;
        }

        .login-logo-wrapper img {
            width: 80px;
            height: 80px;
            border-radius: 20px;
            object-fit: cover;
            box-shadow: 0 8px 30px rgba(14, 165, 233, 0.2);
            border: 3px solid var(--off-white);
        }

        .login-box h2 {
            color: var(--charcoal);
            margin-bottom: 0.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-size: 1.6rem;
        }

        .login-box h2 i {
            display: none;
        }

        .login-box .login-subtitle {
            color: var(--medium-gray);
            margin-bottom: 0.25rem;
            font-size: 0.95rem;
        }

        .login-box p {
            color: var(--silver);
            margin-bottom: 2rem;
            font-size: 0.82rem;
        }

        .login-input-group {
            position: relative;
            margin-bottom: 1.25rem;
            text-align: left;
        }

        .login-input-group label {
            display: block;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--dark-gray);
            margin-bottom: 0.4rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .login-input-wrapper {
            position: relative;
        }

        .login-input-wrapper i {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--silver);
            font-size: 0.95rem;
            transition: color 0.3s;
        }

        .login-box input {
            width: 100%;
            padding: 0.9rem 1rem 0.9rem 2.75rem;
            background: var(--off-white);
            border: 1.5px solid var(--silver-light);
            border-radius: 12px;
            font-size: 0.95rem;
            color: var(--charcoal);
            margin-bottom: 0;
            transition: all 0.3s ease;
        }

        .login-box input::placeholder {
            color: var(--silver);
        }

        .login-box input:focus {
            outline: none;
            border-color: var(--primary-blue);
            background: var(--white);
            box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.1);
        }

        .login-box input:focus + i,
        .login-input-wrapper:focus-within i {
            color: var(--primary-blue);
        }

        .login-box button {
            width: 100%;
            padding: 0.95rem;
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-blue-dark) 100%);
            color: var(--white);
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 16px rgba(14, 165, 233, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.6rem;
            letter-spacing: 0.3px;
        }

        .login-box button:hover {
            background: linear-gradient(135deg, var(--primary-blue-dark) 0%, #0369a1 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 28px rgba(14, 165, 233, 0.4);
        }

        .login-box button:active {
            transform: translateY(0);
        }

        .back-link {
            margin-top: 2rem;
        }

        .back-link a {
            color: var(--medium-gray);
            text-decoration: none;
            font-weight: 500;
            font-size: 0.88rem;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
        }

        .back-link a:hover {
            color: var(--primary-blue);
            text-decoration: none;
            gap: 0.6rem;
        }

        .login-footer-text {
            margin-top: 2.5rem;
            font-size: 0.72rem;
            color: var(--silver);
            line-height: 1.6;
        }

        .login-footer-text i {
            color: var(--primary-blue);
            margin: 0 0.15rem;
        }

        /* Login responsive */
        @media (max-width: 900px) {
            .login-screen {
                flex-direction: column;
            }
            .login-hero {
                flex: 0;
                min-height: 220px;
                max-height: 260px;
            }
            .login-hero-content {
                padding: 1.5rem 2rem;
            }
            .login-hero-content .hero-tagline {
                font-size: 1.4rem;
            }
            .login-hero-badges {
                display: none;
            }
            .login-form-panel {
                flex: 1;
                padding: 2rem 1.5rem;
            }
        }

        @media (max-width: 480px) {
            .login-hero {
                min-height: 160px;
            }
            .login-hero-content .hero-tagline {
                font-size: 1.15rem;
            }
            .login-hero-content .hero-subtitle {
                font-size: 0.85rem;
            }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .admin-header {
                flex-direction: column;
                gap: 1rem;
                padding: 1rem;
            }

            .header-actions {
                flex-wrap: wrap;
                justify-content: center;
            }

            .admin-container {
                padding: 1rem;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .search-box {
                flex-direction: column;
            }

            .quick-actions-row {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 0.75rem;
            }

            .quick-action-btn {
                font-size: 0.8rem;
                padding: 0.85rem 0.75rem;
                gap: 0.5rem;
            }

            .quick-action-btn i {
                font-size: 1rem;
            }

            .calendar-day {
                min-height: 70px;
                padding: 0.5rem;
            }

            .day-number {
                font-size: 0.85rem;
            }

            .appointment-details {
                grid-template-columns: 1fr;
            }
        }

        /* Bill Generation Styles - Clean Style */
        .bill-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(30, 41, 59, 0.5);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }

        .bill-modal.active {
            display: flex;
        }

        .bill-content {
            background: var(--white);
            border: 1px solid var(--silver-light);
            border-radius: 20px;
            max-width: 700px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.2);
        }

        .bill-header {
            background: linear-gradient(135deg, var(--primary-blue), var(--primary-blue-dark));
            color: white;
            padding: 1.5rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 20px 20px 0 0;
        }

        .bill-header h3 {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.3rem;
        }

        .bill-close {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .bill-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

        .bill-form {
            padding: 2rem;
        }

        .bill-form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .bill-form-group {
            margin-bottom: 1rem;
        }

        .bill-form-group label {
            display: block;
            font-weight: 600;
            color: var(--charcoal);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .bill-form-group input,
        .bill-form-group select,
        .bill-form-group textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--silver-light);
            background: var(--off-white);
            border-radius: 12px;
            font-size: 1rem;
            color: var(--charcoal);
            transition: all 0.3s ease;
        }

        .bill-form-group input:focus,
        .bill-form-group select:focus,
        .bill-form-group textarea:focus {
            outline: none;
            border-color: var(--primary-blue);
            background: var(--white);
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
        }

        .bill-items-section {
            background: var(--off-white);
            border: 1px solid var(--silver-light);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .bill-items-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .bill-items-header h4 {
            color: var(--primary-blue);
            font-size: 1.1rem;
        }

        .add-item-btn {
            background: linear-gradient(135deg, var(--primary-blue), var(--accent-purple));
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.35rem;
            transition: all 0.3s ease;
        }

        .add-item-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
        }

        .bill-item {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr auto;
            gap: 0.75rem;
            align-items: center;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 12px;
            margin-bottom: 0.5rem;
            border: 1px solid rgba(99, 102, 241, 0.1);
        }

        .bill-item input {
            padding: 0.5rem;
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: 8px;
            font-size: 0.9rem;
            background: rgba(255, 255, 255, 0.9);
        }

        .remove-item-btn {
            background: linear-gradient(135deg, #ef4444, #f87171);
            color: white;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .remove-item-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }

        .bill-totals {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1));
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .bill-total-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            font-size: 1rem;
        }

        .bill-total-row.grand-total {
            border-top: 2px solid var(--primary-blue);
            margin-top: 0.5rem;
            padding-top: 1rem;
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary-blue);
        }

        .bill-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            padding-top: 1rem;
            border-top: 1px solid #e5e7eb;
        }

        .bill-actions button {
            padding: 0.875rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
        }

        .btn-preview {
            background: #f3f4f6;
            color: var(--charcoal);
        }

        .btn-preview:hover {
            background: #e5e7eb;
        }

        .btn-generate {
            background: var(--accent-green);
            color: white;
        }

        .btn-generate:hover {
            background: #059669;
        }

        /* Bill Preview Styles */
        .bill-preview-container {
            padding: 2rem;
            background: var(--white);
        }

        .bill-preview {
            max-width: 600px;
            margin: 0 auto;
            padding: 2rem;
            border: 1px solid var(--silver-light);
            border-radius: 12px;
            background: var(--white);
        }

        @media (max-width: 768px) {
            .bill-form-row {
                grid-template-columns: 1fr;
            }

            .bill-item {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }

            .bill-actions {
                flex-direction: column;
            }

            .bill-actions button {
                width: 100%;
                justify-content: center;
            }
        }

        /* Analytics Dashboard Styles */
        .analytics-container {
            display: none;
        }

        .analytics-container.active {
            display: block;
        }

        .analytics-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
            background: var(--white);
            border: 1px solid var(--silver-light);
            border-radius: 16px;
            padding: 1.25rem 1.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }

        .analytics-header h2 {
            color: var(--primary-blue);
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .date-range-selector {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .date-range-selector select,
        .date-range-selector input {
            padding: 0.5rem 1rem;
            background: var(--off-white);
            border: 1px solid var(--silver-light);
            border-radius: 10px;
            font-size: 0.9rem;
            color: var(--charcoal);
            transition: all 0.3s ease;
        }

        .date-range-selector select:focus,
        .date-range-selector input:focus {
            border-color: var(--primary-blue);
            outline: none;
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .analytics-card {
            background: var(--white);
            border: 1px solid var(--silver-light);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .analytics-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.1);
        }

        .analytics-card.revenue {
            background: linear-gradient(135deg, #10b981, #059669);
            border: 1px solid #10b981;
            color: white;
        }

        .analytics-card.appointments {
            background: linear-gradient(135deg, var(--primary-blue), var(--primary-blue-dark));
            border: 1px solid var(--primary-blue);
            color: white;
        }

        .analytics-card.patients {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            border: 1px solid #8b5cf6;
            color: white;
        }

        .analytics-card.growth {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            border: 1px solid #f59e0b;
            color: white;
        }

        .analytics-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .analytics-card-icon {
            width: 50px;
            height: 50px;
            background: rgba(255,255,255,0.25);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .analytics-card.white .analytics-card-icon {
            background: rgba(14, 165, 233, 0.1);
            color: var(--primary-blue);
        }

        .analytics-card-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .analytics-card-label {
            font-size: 0.95rem;
            opacity: 0.9;
        }

        .analytics-card-trend {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1rem;
            font-size: 0.85rem;
            background: rgba(255,255,255,0.15);
            padding: 0.35rem 0.75rem;
            border-radius: 20px;
            width: fit-content;
        }

        .analytics-card-trend.up {
            color: #10b981;
        }

        .analytics-card-trend.down {
            color: #ef4444;
        }

        .analytics-card.revenue .analytics-card-trend,
        .analytics-card.appointments .analytics-card-trend,
        .analytics-card.patients .analytics-card-trend,
        .analytics-card.growth .analytics-card-trend {
            color: rgba(255,255,255,0.95);
        }

        .chart-container {
            background: var(--white);
            border: 1px solid var(--silver-light);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            margin-bottom: 1.5rem;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--silver-light);
        }

        .chart-header h3 {
            color: var(--charcoal);
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .chart-legend {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .chart-legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            color: var(--medium-gray);
            background: var(--off-white);
            padding: 0.35rem 0.75rem;
            border-radius: 20px;
            border: 1px solid var(--silver-light);
        }

        .chart-legend-color {
            width: 12px;
            height: 12px;
            border-radius: 4px;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .chart-canvas-container {
            position: relative;
            height: 300px;
        }

        /* Popular Services List */
        .services-list {
            list-style: none;
        }

        .services-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px solid var(--silver-light);
            transition: all 0.3s ease;
        }

        .services-list li:last-child {
            border-bottom: none;
        }

        .services-list li:hover {
            background: var(--off-white);
            border-radius: 10px;
            padding-left: 0.75rem;
            padding-right: 0.75rem;
        }

        .service-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .service-rank {
            width: 30px;
            height: 30px;
            background: rgba(14, 165, 233, 0.1);
            color: var(--primary-blue);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.85rem;
            border: 1px solid rgba(14, 165, 233, 0.2);
        }

        .service-name {
            font-weight: 500;
            color: var(--charcoal);
        }

        .service-count {
            background: var(--off-white);
            border: 1px solid var(--silver-light);
            padding: 0.35rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            color: var(--medium-gray);
            font-weight: 500;
        }

        /* Recent Activity */
        .activity-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .activity-item {
            display: flex;
            gap: 1rem;
            padding: 1rem 0;
            border-bottom: 1px solid #f3f4f6;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            flex-shrink: 0;
        }

        .activity-icon.new {
            background: #dbeafe;
            color: #2563eb;
        }

        .activity-icon.confirmed {
            background: #d1fae5;
            color: #059669;
        }

        .activity-icon.completed {
            background: #e0e7ff;
            color: #4f46e5;
        }

        .activity-icon.cancelled {
            background: #fee2e2;
            color: #dc2626;
        }

        .activity-content {
            flex: 1;
        }

        .activity-title {
            font-weight: 500;
            color: var(--charcoal);
            margin-bottom: 0.25rem;
        }

        .activity-time {
            font-size: 0.8rem;
            color: var(--medium-gray);
        }

        /* Status Distribution */
        .status-bars {
            margin-top: 1rem;
        }

        .status-bar-item {
            margin-bottom: 1rem;
        }

        .status-bar-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .status-bar-label {
            color: var(--charcoal);
            font-weight: 500;
        }

        .status-bar-value {
            color: var(--medium-gray);
        }

        .status-bar-track {
            height: 8px;
            background: #f3f4f6;
            border-radius: 4px;
            overflow: hidden;
        }

        .status-bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .status-bar-fill.pending {
            background: linear-gradient(90deg, #fbbf24, #f59e0b);
        }

        .status-bar-fill.confirmed {
            background: linear-gradient(90deg, #34d399, #10b981);
        }

        .status-bar-fill.completed {
            background: linear-gradient(90deg, #818cf8, #6366f1);
        }

        .status-bar-fill.cancelled {
            background: linear-gradient(90deg, #f87171, #ef4444);
        }

        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }

            .analytics-grid {
                grid-template-columns: 1fr 1fr;
            }

            .chart-canvas-container {
                height: 250px;
            }
        }

        @media (max-width: 480px) {
            .analytics-grid {
                grid-template-columns: 1fr;
            }
        }

        /* ==================== FEEDBACK STYLES ==================== */
        .feedback-container {
            padding: 1.5rem;
            background: var(--white);
            border: 1px solid var(--silver-light);
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            min-height: 500px;
        }

        .feedback-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
            background: var(--white);
            border: 1px solid var(--silver-light);
            border-radius: 16px;
            padding: 1.25rem 1.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }

        .feedback-header h2 {
            color: var(--primary-blue);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .feedback-tabs {
            display: flex;
            gap: 0.5rem;
            background: var(--off-white);
            padding: 0.35rem;
            border-radius: 12px;
            border: 1px solid var(--silver-light);
        }

        .feedback-tab {
            padding: 0.5rem 1rem;
            border: none;
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            color: var(--medium-gray);
            transition: all 0.3s ease;
        }

        .feedback-tab.active {
            background: var(--primary-blue);
            color: white;
            box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);
        }

        .feedback-tab:hover:not(.active) {
            background: var(--white);
        }

        .feedback-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        @media (max-width: 1024px) {
            .feedback-content {
                grid-template-columns: 1fr;
            }
        }

        /* Feedback Form */
        .feedback-form-card {
            background: var(--white);
            border: 1px solid var(--silver-light);
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            overflow: hidden;
        }

        .feedback-form-header {
            background: linear-gradient(135deg, var(--primary-blue), var(--primary-blue-dark));
            color: white;
            padding: 1.25rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .feedback-form-header i {
            font-size: 1.25rem;
        }

        .feedback-form-body {
            padding: 1.5rem;
            background: var(--white);
        }

        .feedback-form-group {
            margin-bottom: 1.25rem;
        }

        .feedback-form-group label {
            display: block;
            font-weight: 600;
            color: var(--charcoal);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .feedback-form-group label i {
            color: var(--primary-blue);
            margin-right: 0.5rem;
        }

        .feedback-form-group input,
        .feedback-form-group select,
        .feedback-form-group textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            background: var(--off-white);
            border: 1px solid var(--silver-light);
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            font-family: inherit;
            color: var(--charcoal);
        }

        .feedback-form-group input:focus,
        .feedback-form-group select:focus,
        .feedback-form-group textarea:focus {
            border-color: var(--primary-blue);
            outline: none;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15);
            background: rgba(255,255,255,0.8);
        }

        .feedback-form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        /* Star Rating */
        .star-rating {
            display: flex;
            gap: 0.5rem;
            flex-direction: row-reverse;
            justify-content: flex-end;
        }

        .star-rating input {
            display: none;
        }

        .star-rating label {
            font-size: 2rem;
            color: rgba(209, 213, 219, 0.8);
            cursor: pointer;
            transition: all 0.2s ease;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .star-rating label:hover,
        .star-rating label:hover ~ label,
        .star-rating input:checked ~ label {
            color: #fbbf24;
            text-shadow: 0 0 15px rgba(251, 191, 36, 0.5);
        }

        .star-rating label:hover {
            transform: scale(1.15);
        }

        /* Category Tags */
        .category-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .category-tag {
            padding: 0.5rem 1rem;
            border: 1px solid var(--silver-light);
            border-radius: 25px;
            background: var(--off-white);
            cursor: pointer;
            font-size: 0.9rem;
            color: var(--medium-gray);
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            user-select: none;
            position: relative;
        }

        .category-tag:hover {
            border-color: var(--primary-blue);
            background: rgba(14, 165, 233, 0.1);
            color: var(--primary-blue);
            transform: translateY(-1px);
        }

        .category-tag.selected {
            background: var(--primary-blue) !important;
            color: white !important;
            border-color: var(--primary-blue) !important;
            box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);
            transform: translateY(-1px);
        }

        .category-tag input {
            display: none;
            pointer-events: none;
        }

        .category-tag input:checked + span,
        .category-tag:has(input:checked) {
            color: white;
        }

        /* Homepage Toggle Switch */
        .homepage-toggle {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            padding: 0.75rem 1rem;
            background: var(--off-white);
            border: 1px solid var(--silver-light);
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .homepage-toggle:hover {
            border-color: var(--primary-blue);
            background: rgba(14, 165, 233, 0.05);
        }

        .homepage-toggle input {
            display: none;
        }

        .toggle-slider {
            position: relative;
            width: 50px;
            height: 26px;
            background: var(--silver);
            border-radius: 13px;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .toggle-slider::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .homepage-toggle input:checked + .toggle-slider {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .homepage-toggle input:checked + .toggle-slider::after {
            transform: translateX(24px);
        }

        .toggle-label {
            font-weight: 500;
            color: var(--charcoal);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .toggle-label i {
            color: var(--primary-blue);
        }

        /* Form Actions */
        .feedback-form-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--silver-light);
        }

        .feedback-form-actions button {
            flex: 1;
            padding: 0.875rem 1.5rem;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn-submit-feedback {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: 1px solid #10b981;
        }

        .btn-submit-feedback:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
        }

        .btn-clear-feedback {
            background: var(--off-white);
            color: var(--charcoal);
            border: 1px solid var(--silver-light);
        }

        .btn-clear-feedback:hover {
            background: rgba(255,255,255,0.7);
        }

        /* Feedback List */
        .feedback-list-card {
            background: var(--white);
            border: 1px solid var(--silver-light);
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            overflow: hidden;
            max-height: 700px;
            display: flex;
            flex-direction: column;
        }

        .feedback-list-header {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
            padding: 1.25rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: none;
        }

        .feedback-list-header h3 {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .feedback-count-badge {
            background: rgba(255,255,255,0.25);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .feedback-list-body {
            padding: 1rem;
            overflow-y: auto;
            flex: 1;
            background: var(--white);
        }

        .feedback-item {
            background: var(--off-white);
            border: 1px solid var(--silver-light);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            border-left: 4px solid var(--primary-blue);
            transition: all 0.3s ease;
        }

        .feedback-item:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            transform: translateX(4px);
            background: var(--white);
        }

        .feedback-item.rating-5 { border-left-color: #10b981; }
        .feedback-item.rating-4 { border-left-color: #22c55e; }
        .feedback-item.rating-3 { border-left-color: #fbbf24; }
        .feedback-item.rating-2 { border-left-color: #f97316; }
        .feedback-item.rating-1 { border-left-color: #ef4444; }

        .feedback-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
        }

        .feedback-patient-info h4 {
            color: var(--charcoal);
            margin-bottom: 0.25rem;
        }

        .feedback-patient-info .appointment-ref {
            font-size: 0.8rem;
            color: var(--medium-gray);
        }

        .feedback-rating {
            display: flex;
            gap: 0.15rem;
        }

        .feedback-rating i {
            color: #fbbf24;
            font-size: 0.9rem;
        }

        .feedback-rating i.empty {
            color: #d1d5db;
        }

        /* Homepage Badge */
        .homepage-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            background: rgba(16, 185, 129, 0.1);
            color: #059669;
            padding: 0.2rem 0.5rem;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 0.5rem;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .homepage-badge i {
            font-size: 0.6rem;
        }

        .feedback-action-btn.homepage {
            background: var(--off-white);
            color: var(--medium-gray);
            border: 1px solid var(--silver-light);
        }

        .feedback-action-btn.homepage:hover {
            background: rgba(16, 185, 129, 0.1);
            color: #059669;
            border-color: rgba(16, 185, 129, 0.3);
        }

        .feedback-action-btn.homepage-active {
            background: rgba(16, 185, 129, 0.15);
            color: #059669;
            border: 1px solid rgba(16, 185, 129, 0.4);
        }

        .feedback-action-btn.homepage-active:hover {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border-color: rgba(239, 68, 68, 0.3);
        }

        .feedback-categories {
            display: flex;
            flex-wrap: wrap;
            gap: 0.35rem;
            margin-bottom: 0.75rem;
        }

        .feedback-category-tag {
            background: rgba(14, 165, 233, 0.1);
            color: var(--primary-blue);
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
            border: 1px solid rgba(14, 165, 233, 0.2);
        }

        .feedback-comment {
            color: var(--charcoal);
            font-size: 0.9rem;
            line-height: 1.5;
            background: var(--white);
            border: 1px solid var(--silver-light);
            padding: 0.75rem;
            border-radius: 10px;
            margin-bottom: 0.75rem;
        }

        .feedback-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
            color: var(--medium-gray);
        }

        .feedback-actions {
            display: flex;
            gap: 0.5rem;
        }

        .feedback-action-btn {
            padding: 0.35rem 0.75rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 0.35rem;
            transition: all 0.3s ease;
        }

        .feedback-action-btn.delete {
            background: rgba(254, 242, 242, 0.8);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .feedback-action-btn.delete:hover {
            background: rgba(254, 226, 226, 0.9);
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.2);
        }

        .feedback-action-btn.export {
            background: rgba(239, 246, 255, 0.8);
            color: var(--primary-blue);
            border: 1px solid rgba(37, 99, 235, 0.2);
        }

        .feedback-action-btn.export:hover {
            background: rgba(219, 234, 254, 0.9);
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.2);
        }

        /* Feedback Stats */
        .feedback-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
        }

        @media (max-width: 768px) {
            .feedback-stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .feedback-stat-card {
            background: var(--white);
            border: 1px solid var(--silver-light);
            border-radius: 16px;
            padding: 1.25rem;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            transition: all 0.3s ease;
        }

        .feedback-stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.1);
        }

        .feedback-stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 0.75rem;
            font-size: 1.25rem;
        }

        .feedback-stat-icon.total { 
            background: rgba(14, 165, 233, 0.1); 
            color: var(--primary-blue);
            border: 1px solid rgba(14, 165, 233, 0.2);
        }
        .feedback-stat-icon.average { 
            background: rgba(245, 158, 11, 0.1); 
            color: #f59e0b;
            border: 1px solid rgba(245, 158, 11, 0.2);
        }
        .feedback-stat-icon.positive { 
            background: rgba(16, 185, 129, 0.1); 
            color: #10b981;
            border: 1px solid rgba(16, 185, 129, 0.2);
        }
        .feedback-stat-icon.negative { 
            background: rgba(239, 68, 68, 0.1); 
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .feedback-stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--charcoal);
            margin-bottom: 0.25rem;
        }

        .feedback-stat-label {
            font-size: 0.85rem;
            color: var(--medium-gray);
        }

        /* Empty Feedback State */
        .empty-feedback {
            text-align: center;
            padding: 3rem 2rem;
            color: var(--medium-gray);
            background: var(--off-white);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            margin: 1rem;
        }

        .empty-feedback i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.6;
            color: var(--primary-blue);
        }

        .empty-feedback h3 {
            color: var(--charcoal);
            margin-bottom: 0.5rem;
        }

        /* Custom Scrollbar - Glassmorphism Style */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.4), rgba(59, 130, 246, 0.6));
            border-radius: 10px;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.6), rgba(59, 130, 246, 0.8));
        }

        /* Floating Background Orbs */
        .bg-orbs {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
            overflow: hidden;
        }

        .bg-orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(60px);
            opacity: 0.5;
            animation: floatOrb 20s ease-in-out infinite;
        }

        .bg-orb.orb-1 {
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, rgba(99, 102, 241, 0.4), transparent);
            top: -100px;
            right: -100px;
            animation-delay: 0s;
        }

        .bg-orb.orb-2 {
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, rgba(16, 185, 129, 0.3), transparent);
            bottom: -50px;
            left: -50px;
            animation-delay: -7s;
        }

        .bg-orb.orb-3 {
            width: 250px;
            height: 250px;
            background: radial-gradient(circle, rgba(245, 158, 11, 0.3), transparent);
            top: 40%;
            left: 30%;
            animation-delay: -14s;
        }

        @keyframes floatOrb {
            0%, 100% {
                transform: translate(0, 0) scale(1);
            }
            25% {
                transform: translate(30px, -30px) scale(1.05);
            }
            50% {
                transform: translate(-20px, 20px) scale(0.95);
            }
            75% {
                transform: translate(-30px, -20px) scale(1.02);
            }
        }

        /* Focus States Enhancement */
        button:focus-visible,
        input:focus-visible,
        select:focus-visible,
        textarea:focus-visible {
            outline: 2px solid var(--primary-blue);
            outline-offset: 2px;
        }

        /* Selection Color */
        ::selection {
            background: rgba(37, 99, 235, 0.3);
            color: var(--charcoal);
        }
    </style>
</head>
<body>
    <!-- Floating Background Orbs -->
    <div class="bg-orbs">
        <div class="bg-orb orb-1"></div>
        <div class="bg-orb orb-2"></div>
        <div class="bg-orb orb-3"></div>
    </div>

    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <!-- Left Hero Panel with Dental Image -->
        <div class="login-hero">
            <img src="https://images.unsplash.com/photo-1629909613654-28e377c37b09?auto=format&fit=crop&w=1200&q=80" alt="Modern Dental Clinic" class="login-hero-img">
            <div class="login-hero-overlay"></div>
            <div class="login-hero-content">
                <div class="hero-tagline">Exceptional Dental Care,<br><span>Powered by Technology</span></div>
                <p class="hero-subtitle">Manage appointments, billing, analytics, and patient records — all from one secure admin portal.</p>
                <div class="login-hero-badges">
                    <div class="login-hero-badge"><i class="fas fa-shield-alt"></i> 256-bit Encrypted</div>
                    <div class="login-hero-badge"><i class="fas fa-cloud-upload-alt"></i> Cloud Synced</div>
                    <div class="login-hero-badge"><i class="fas fa-chart-pie"></i> Real-time Analytics</div>
                </div>
            </div>
        </div>

        <!-- Right Form Panel -->
        <div class="login-form-panel">
            <div class="login-box">
                <div class="login-logo-wrapper">
                    <img src="shalom_dental_logo.png" alt="Shalom Dental Care Logo" onerror="this.style.display='none'">
                </div>
                <h2>Shalom Dental Care</h2>
                <p class="login-subtitle">Admin Portal</p>
                <p>Enter your credentials to access the dashboard</p>

                <div class="login-input-group">
                    <label for="loginPassword">Password</label>
                    <div class="login-input-wrapper">
                        <input type="password" id="loginPassword" placeholder="Enter admin password" onkeypress="if(event.key==='Enter') adminPortal.login()">
                        <i class="fas fa-lock"></i>
                    </div>
                </div>

                <button onclick="adminPortal.login()">
                    <i class="fas fa-sign-in-alt"></i> Sign In
                </button>

                <div class="back-link">
                    <a href="dental-homepage.html"><i class="fas fa-arrow-left"></i> Back to Website</a>
                </div>

                <div class="login-footer-text">
                    <i class="fas fa-map-marker-alt"></i> 76/2, Gandhi Road, Srinivasa Nagar, New Perungalathur, Chennai 600063<br>
                    <i class="fas fa-phone"></i> +91 86107 76477
                </div>
            </div>
        </div>
    </div>

    <!-- Main Admin Panel -->
    <div id="adminApp" style="display: none;">
        <header class="admin-header">
            <h1>
                <img src="shalom_dental_logo.png" alt="Shalom Dental Care Logo" class="header-logo" onerror="this.style.display='none'">
                <span class="header-brand">
                    Shalom Dental Care
                    <small>Admin Portal</small>
                </span>
            </h1>
            <div class="header-actions">
                <span class="status-badge" id="connectionStatus">
                    <i class="fas fa-cloud"></i> <span>Connecting...</span>
                </span>
                <button class="btn-secondary" onclick="adminPortal.syncData()">
                    <i class="fas fa-sync"></i> Sync
                </button>
                <button class="btn-success" onclick="adminPortal.exportCSV()">
                    <i class="fas fa-download"></i> Export CSV
                </button>
                <button class="btn-secondary" onclick="adminPortal.changePassword()">
                    <i class="fas fa-key"></i> Password
                </button>
                <button class="btn-danger" onclick="adminPortal.logout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </header>

        <div class="admin-container">
            <!-- Stats -->
            <div class="stats-grid">
                <div class="stat-card pending">
                    <div class="stat-number" id="pendingCount">0</div>
                    <div class="stat-label"><i class="fas fa-clock"></i> Pending</div>
                </div>
                <div class="stat-card confirmed">
                    <div class="stat-number" id="confirmedCount">0</div>
                    <div class="stat-label"><i class="fas fa-check-circle"></i> Confirmed</div>
                </div>
                <div class="stat-card today">
                    <div class="stat-number" id="todayCount">0</div>
                    <div class="stat-label"><i class="fas fa-calendar-day"></i> Today</div>
                </div>
                <div class="stat-card total">
                    <div class="stat-number" id="totalCount">0</div>
                    <div class="stat-label"><i class="fas fa-list"></i> Total</div>
                </div>
            </div>

            <!-- Quick Action Buttons: All Views -->
            <div class="quick-actions-row">
                <button class="quick-action-btn appointments-btn active" id="appointmentsQuickBtn" onclick="adminPortal.switchView('list', this)">
                    <i class="fas fa-calendar-check"></i> Appointments
                </button>
                <button class="quick-action-btn calendar-quick-btn" id="calendarQuickBtn" onclick="adminPortal.switchView('calendar', this)">
                    <i class="fas fa-calendar-alt"></i> Calendar
                </button>
                <button class="quick-action-btn analytics-btn" id="analyticsQuickBtn" onclick="adminPortal.switchView('analytics', this)">
                    <i class="fas fa-chart-line"></i> Analytics
                </button>
                <button class="quick-action-btn feedback-btn" id="feedbackQuickBtn" onclick="adminPortal.switchView('feedback', this)">
                    <i class="fas fa-comment-dots"></i> Feedback
                    <span class="btn-badge" id="feedbackBadgeCount">0</span>
                </button>
            </div>

            <!-- Controls -->
            <div class="controls-section" id="controlsSection">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="Search by name, phone, email, or appointment ID..." oninput="adminPortal.search(this.value)">
                </div>
                <div class="filter-tabs" id="filterTabs">
                    <button class="filter-tab active" onclick="adminPortal.filter('all', this)">All</button>
                    <button class="filter-tab" onclick="adminPortal.filter('pending', this)">Pending</button>
                    <button class="filter-tab" onclick="adminPortal.filter('confirmed', this)">Confirmed</button>
                    <button class="filter-tab" onclick="adminPortal.filter('completed', this)">Completed</button>
                    <button class="filter-tab" onclick="adminPortal.filter('cancelled', this)">Cancelled</button>
                </div>
            </div>

            <!-- Content Area -->
            <div class="content-area">
                <!-- List View -->
                <div id="listView">
                    <div class="appointments-grid" id="appointmentsList"></div>
                </div>

                <!-- Calendar View -->
                <div id="calendarView" style="display: none;">
                    <div class="calendar-container">
                        <div class="calendar-header">
                            <h3 id="calendarMonthYear">February 2026</h3>
                            <div class="calendar-nav">
                                <button onclick="adminPortal.previousMonth()">
                                    <i class="fas fa-chevron-left"></i> Prev
                                </button>
                                <button onclick="adminPortal.goToToday()">Today</button>
                                <button onclick="adminPortal.nextMonth()">
                                    Next <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                        <div id="calendarGrid"></div>
                    </div>
                </div>

                <!-- Analytics Dashboard View -->
                <div id="analyticsView" style="display: none;">
                    <div class="analytics-container active">
                        <!-- Analytics Header -->
                        <div class="analytics-header">
                            <h2><i class="fas fa-chart-pie"></i> Analytics Dashboard</h2>
                            <div class="date-range-selector">
                                <select id="analyticsRange" onchange="adminPortal.updateAnalytics()">
                                    <option value="7">Last 7 Days</option>
                                    <option value="30" selected>Last 30 Days</option>
                                    <option value="90">Last 90 Days</option>
                                    <option value="365">Last Year</option>
                                    <option value="all">All Time</option>
                                </select>
                            </div>
                        </div>

                        <!-- Key Metrics Cards -->
                        <div class="analytics-grid">
                            <div class="analytics-card revenue">
                                <div class="analytics-card-header">
                                    <div>
                                        <div class="analytics-card-value" id="analyticsRevenue">₹0</div>
                                        <div class="analytics-card-label">Estimated Revenue</div>
                                    </div>
                                    <div class="analytics-card-icon">
                                        <i class="fas fa-rupee-sign"></i>
                                    </div>
                                </div>
                                <div class="analytics-card-trend" id="revenueTrend">
                                    <i class="fas fa-arrow-up"></i> <span>+0% from last period</span>
                                </div>
                            </div>

                            <div class="analytics-card appointments">
                                <div class="analytics-card-header">
                                    <div>
                                        <div class="analytics-card-value" id="analyticsAppointments">0</div>
                                        <div class="analytics-card-label">Total Appointments</div>
                                    </div>
                                    <div class="analytics-card-icon">
                                        <i class="fas fa-calendar-check"></i>
                                    </div>
                                </div>
                                <div class="analytics-card-trend" id="appointmentsTrend">
                                    <i class="fas fa-arrow-up"></i> <span>+0% from last period</span>
                                </div>
                            </div>

                            <div class="analytics-card patients">
                                <div class="analytics-card-header">
                                    <div>
                                        <div class="analytics-card-value" id="analyticsPatients">0</div>
                                        <div class="analytics-card-label">Unique Patients</div>
                                    </div>
                                    <div class="analytics-card-icon">
                                        <i class="fas fa-users"></i>
                                    </div>
                                </div>
                                <div class="analytics-card-trend" id="patientsTrend">
                                    <i class="fas fa-arrow-up"></i> <span>+0% from last period</span>
                                </div>
                            </div>

                            <div class="analytics-card growth">
                                <div class="analytics-card-header">
                                    <div>
                                        <div class="analytics-card-value" id="analyticsCompletionRate">0%</div>
                                        <div class="analytics-card-label">Completion Rate</div>
                                    </div>
                                    <div class="analytics-card-icon">
                                        <i class="fas fa-chart-line"></i>
                                    </div>
                                </div>
                                <div class="analytics-card-trend" id="completionTrend">
                                    <i class="fas fa-arrow-up"></i> <span>+0% from last period</span>
                                </div>
                            </div>
                        </div>

                        <!-- Charts Row -->
                        <div class="charts-grid">
                            <!-- Appointments Over Time Chart -->
                            <div class="chart-container">
                                <div class="chart-header">
                                    <h3><i class="fas fa-chart-area"></i> Appointments Over Time</h3>
                                </div>
                                <div class="chart-canvas-container">
                                    <canvas id="appointmentsChart"></canvas>
                                </div>
                            </div>

                            <!-- Status Distribution Chart -->
                            <div class="chart-container">
                                <div class="chart-header">
                                    <h3><i class="fas fa-chart-pie"></i> Status Distribution</h3>
                                </div>
                                <div class="chart-canvas-container">
                                    <canvas id="statusChart"></canvas>
                                </div>
                            </div>
                        </div>

                        <!-- Second Row -->
                        <div class="charts-grid">
                            <!-- Services Chart -->
                            <div class="chart-container">
                                <div class="chart-header">
                                    <h3><i class="fas fa-tooth"></i> Popular Services</h3>
                                </div>
                                <div class="chart-canvas-container">
                                    <canvas id="servicesChart"></canvas>
                                </div>
                            </div>

                            <!-- Day of Week Distribution -->
                            <div class="chart-container">
                                <div class="chart-header">
                                    <h3><i class="fas fa-calendar-week"></i> Busiest Days</h3>
                                </div>
                                <div class="chart-canvas-container">
                                    <canvas id="daysChart"></canvas>
                                </div>
                            </div>
                        </div>

                        <!-- Bottom Row -->
                        <div class="charts-grid">
                            <!-- Top Services List -->
                            <div class="chart-container">
                                <div class="chart-header">
                                    <h3><i class="fas fa-list-ol"></i> Top Services Breakdown</h3>
                                </div>
                                <ul class="services-list" id="topServicesList">
                                    <!-- Populated by JS -->
                                </ul>
                            </div>

                            <!-- Status Progress Bars -->
                            <div class="chart-container">
                                <div class="chart-header">
                                    <h3><i class="fas fa-tasks"></i> Appointment Status Overview</h3>
                                </div>
                                <div class="status-bars" id="statusBars">
                                    <!-- Populated by JS -->
                                </div>
                            </div>
                        </div>

                        <!-- Recent Activity -->
                        <div class="chart-container">
                            <div class="chart-header">
                                <h3><i class="fas fa-history"></i> Recent Activity</h3>
                            </div>
                            <div class="activity-list" id="recentActivityList">
                                <!-- Populated by JS -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Feedback View -->
            <div id="feedbackView" style="display: none;">
                <div class="feedback-container">
                    <!-- Feedback Header -->
                    <div class="feedback-header">
                        <h2><i class="fas fa-comment-dots"></i> Patient Feedback Management</h2>
                        <div class="feedback-tabs">
                            <button class="feedback-tab active" onclick="adminPortal.switchFeedbackTab('entry', this)">
                                <i class="fas fa-plus-circle"></i> New Entry
                            </button>
                            <button class="feedback-tab" onclick="adminPortal.switchFeedbackTab('list', this)">
                                <i class="fas fa-list"></i> All Feedback
                            </button>
                        </div>
                    </div>

                    <!-- Feedback Statistics -->
                    <div class="feedback-stats">
                        <div class="feedback-stat-card">
                            <div class="feedback-stat-icon total">
                                <i class="fas fa-comments"></i>
                            </div>
                            <div class="feedback-stat-value" id="totalFeedbackCount">0</div>
                            <div class="feedback-stat-label">Total Feedback</div>
                        </div>
                        <div class="feedback-stat-card">
                            <div class="feedback-stat-icon average">
                                <i class="fas fa-star"></i>
                            </div>
                            <div class="feedback-stat-value" id="avgRating">0.0</div>
                            <div class="feedback-stat-label">Average Rating</div>
                        </div>
                        <div class="feedback-stat-card">
                            <div class="feedback-stat-icon positive">
                                <i class="fas fa-smile"></i>
                            </div>
                            <div class="feedback-stat-value" id="positiveFeedbackCount">0</div>
                            <div class="feedback-stat-label">Positive (4-5★)</div>
                        </div>
                        <div class="feedback-stat-card">
                            <div class="feedback-stat-icon negative">
                                <i class="fas fa-frown"></i>
                            </div>
                            <div class="feedback-stat-value" id="negativeFeedbackCount">0</div>
                            <div class="feedback-stat-label">Needs Attention (1-2★)</div>
                        </div>
                    </div>

                    <!-- Feedback Content -->
                    <div class="feedback-content">
                        <!-- Feedback Entry Form -->
                        <div class="feedback-form-card" id="feedbackEntrySection">
                            <div class="feedback-form-header">
                                <i class="fas fa-edit"></i>
                                <h3>Record Patient Feedback</h3>
                            </div>
                            <div class="feedback-form-body">
                                <form id="feedbackForm" onsubmit="adminPortal.submitFeedback(event)">
                                    <!-- Patient Selection -->
                                    <div class="feedback-form-group">
                                        <label><i class="fas fa-user"></i> Patient / Appointment</label>
                                        <select id="feedbackAppointment" required>
                                            <option value="">-- Select a patient/appointment --</option>
                                        </select>
                                    </div>

                                    <!-- Patient Name (for manual entry) -->
                                    <div class="feedback-form-group">
                                        <label><i class="fas fa-user-edit"></i> Patient Name (if not in list)</label>
                                        <input type="text" id="feedbackPatientName" placeholder="Enter patient name manually">
                                    </div>

                                    <!-- Phone Number -->
                                    <div class="feedback-form-group">
                                        <label><i class="fas fa-phone"></i> Phone Number</label>
                                        <input type="tel" id="feedbackPhone" placeholder="Enter phone number">
                                    </div>

                                    <!-- Star Rating -->
                                    <div class="feedback-form-group">
                                        <label><i class="fas fa-star"></i> Overall Rating</label>
                                        <div class="star-rating">
                                            <input type="radio" name="rating" value="5" id="star5">
                                            <label for="star5" title="Excellent"><i class="fas fa-star"></i></label>
                                            <input type="radio" name="rating" value="4" id="star4">
                                            <label for="star4" title="Good"><i class="fas fa-star"></i></label>
                                            <input type="radio" name="rating" value="3" id="star3">
                                            <label for="star3" title="Average"><i class="fas fa-star"></i></label>
                                            <input type="radio" name="rating" value="2" id="star2">
                                            <label for="star2" title="Poor"><i class="fas fa-star"></i></label>
                                            <input type="radio" name="rating" value="1" id="star1">
                                            <label for="star1" title="Very Poor"><i class="fas fa-star"></i></label>
                                        </div>
                                    </div>

                                    <!-- Feedback Categories -->
                                    <div class="feedback-form-group">
                                        <label><i class="fas fa-tags"></i> Categories (Select all that apply)</label>
                                        <div class="category-tags">
                                            <label class="category-tag">
                                                <input type="checkbox" name="category" value="cleanliness">
                                                🧹 Cleanliness
                                            </label>
                                            <label class="category-tag">
                                                <input type="checkbox" name="category" value="staff">
                                                👨‍⚕️ Staff Behavior
                                            </label>
                                            <label class="category-tag">
                                                <input type="checkbox" name="category" value="treatment">
                                                🦷 Treatment Quality
                                            </label>
                                            <label class="category-tag">
                                                <input type="checkbox" name="category" value="wait-time">
                                                ⏱️ Wait Time
                                            </label>
                                            <label class="category-tag">
                                                <input type="checkbox" name="category" value="pricing">
                                                💰 Pricing
                                            </label>
                                            <label class="category-tag">
                                                <input type="checkbox" name="category" value="facilities">
                                                🏥 Facilities
                                            </label>
                                            <label class="category-tag">
                                                <input type="checkbox" name="category" value="communication">
                                                💬 Communication
                                            </label>
                                            <label class="category-tag">
                                                <input type="checkbox" name="category" value="followup">
                                                📞 Follow-up Care
                                            </label>
                                        </div>
                                    </div>

                                    <!-- Feedback Comments -->
                                    <div class="feedback-form-group">
                                        <label><i class="fas fa-comment-alt"></i> Detailed Comments</label>
                                        <textarea id="feedbackComments" placeholder="Enter patient's feedback comments, suggestions, or concerns..."></textarea>
                                    </div>

                                    <!-- Would Recommend -->
                                    <div class="feedback-form-group">
                                        <label><i class="fas fa-thumbs-up"></i> Would Recommend to Others?</label>
                                        <select id="feedbackRecommend">
                                            <option value="">-- Select --</option>
                                            <option value="yes">Yes, definitely</option>
                                            <option value="maybe">Maybe</option>
                                            <option value="no">No</option>
                                        </select>
                                    </div>

                                    <!-- Source -->
                                    <div class="feedback-form-group">
                                        <label><i class="fas fa-source"></i> Feedback Source</label>
                                        <select id="feedbackSource">
                                            <option value="in-person">In-Person</option>
                                            <option value="phone">Phone Call</option>
                                            <option value="whatsapp">WhatsApp</option>
                                            <option value="email">Email</option>
                                            <option value="google">Google Review</option>
                                            <option value="social">Social Media</option>
                                            <option value="other">Other</option>
                                        </select>
                                    </div>

                                    <!-- Staff Notes -->
                                    <div class="feedback-form-group">
                                        <label><i class="fas fa-sticky-note"></i> Internal Notes (Staff Only)</label>
                                        <textarea id="feedbackInternalNotes" placeholder="Add any internal notes or follow-up actions needed..."></textarea>
                                    </div>

                                    <!-- Show on Homepage Toggle -->
                                    <div class="feedback-form-group">
                                        <label class="homepage-toggle">
                                            <input type="checkbox" id="feedbackShowOnHomepage">
                                            <span class="toggle-slider"></span>
                                            <span class="toggle-label"><i class="fas fa-globe"></i> Display on Website Homepage</span>
                                        </label>
                                        <small style="color: var(--medium-gray); display: block; margin-top: 0.5rem;">
                                            <i class="fas fa-info-circle"></i> Only ratings 4★ and above will be displayed publicly
                                        </small>
                                    </div>

                                    <!-- Form Actions -->
                                    <div class="feedback-form-actions">
                                        <button type="button" class="btn-clear-feedback" onclick="adminPortal.clearFeedbackForm()">
                                            <i class="fas fa-eraser"></i> Clear
                                        </button>
                                        <button type="submit" class="btn-submit-feedback">
                                            <i class="fas fa-save"></i> Save Feedback
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <!-- Feedback List -->
                        <div class="feedback-list-card" id="feedbackListSection">
                            <div class="feedback-list-header">
                                <h3><i class="fas fa-clipboard-list"></i> Recent Feedback</h3>
                                <span class="feedback-count-badge" id="feedbackListCount">0 entries</span>
                            </div>
                            <div class="feedback-list-body" id="feedbackListContainer">
                                <!-- Populated by JS -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Day Detail Modal -->
    <div class="modal-overlay" id="dayModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-calendar-day"></i> <span id="modalDate">Date</span></h3>
                <button class="modal-close" onclick="adminPortal.closeModal()">&times;</button>
            </div>
            <div id="modalAppointments"></div>
        </div>
    </div>

    <!-- Bill Generation Modal -->
    <div class="bill-modal" id="billModal">
        <div class="bill-content">
            <div class="bill-header">
                <h3><i class="fas fa-file-invoice-dollar"></i> Generate Bill</h3>
                <button class="bill-close" onclick="adminPortal.closeBillModal()">&times;</button>
            </div>
            <div class="bill-form">
                <input type="hidden" id="billAppointmentId">
                
                <!-- Patient Information -->
                <div class="bill-form-row">
                    <div class="bill-form-group">
                        <label><i class="fas fa-user"></i> Patient Name</label>
                        <input type="text" id="billPatientName" readonly>
                    </div>
                    <div class="bill-form-group">
                        <label><i class="fas fa-phone"></i> Phone</label>
                        <input type="text" id="billPatientPhone" readonly>
                    </div>
                </div>
                <div class="bill-form-row">
                    <div class="bill-form-group">
                        <label><i class="fas fa-envelope"></i> Email</label>
                        <input type="text" id="billPatientEmail" readonly>
                    </div>
                    <div class="bill-form-group">
                        <label><i class="fas fa-calendar"></i> Appointment Date</label>
                        <input type="text" id="billAppointmentDate" readonly>
                    </div>
                </div>

                <!-- Bill Details -->
                <div class="bill-form-row">
                    <div class="bill-form-group">
                        <label><i class="fas fa-hashtag"></i> Bill Number</label>
                        <input type="text" id="billNumber" readonly>
                    </div>
                    <div class="bill-form-group">
                        <label><i class="fas fa-calendar-alt"></i> Bill Date</label>
                        <input type="date" id="billDate">
                    </div>
                </div>

                <!-- Bill Items -->
                <div class="bill-items-section">
                    <div class="bill-items-header">
                        <h4><i class="fas fa-list-ul"></i> Services / Items</h4>
                        <button class="add-item-btn" onclick="adminPortal.addBillItem()">
                            <i class="fas fa-plus"></i> Add Item
                        </button>
                    </div>
                    <div style="font-size: 0.8rem; color: #6b7280; margin-bottom: 0.75rem; display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: 0.75rem; padding: 0 0.75rem;">
                        <span>Description</span>
                        <span>Qty</span>
                        <span>Rate (₹)</span>
                        <span>Amount (₹)</span>
                        <span></span>
                    </div>
                    <div id="billItemsContainer"></div>
                </div>

                <!-- Totals -->
                <div class="bill-totals">
                    <div class="bill-total-row">
                        <span>Subtotal</span>
                        <span id="billSubtotal">₹0.00</span>
                    </div>
                    <div class="bill-total-row">
                        <span>Discount</span>
                        <span style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="number" id="billDiscount" value="0" min="0" style="width: 80px; padding: 0.35rem; border: 1px solid #ddd; border-radius: 4px;" onchange="adminPortal.calculateBillTotal()">
                            <span>%</span>
                        </span>
                    </div>
                    <div class="bill-total-row">
                        <span>Tax (GST)</span>
                        <span style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="number" id="billTax" value="0" min="0" style="width: 80px; padding: 0.35rem; border: 1px solid #ddd; border-radius: 4px;" onchange="adminPortal.calculateBillTotal()">
                            <span>%</span>
                        </span>
                    </div>
                    <div class="bill-total-row grand-total">
                        <span>Grand Total</span>
                        <span id="billGrandTotal">₹0.00</span>
                    </div>
                </div>

                <!-- Payment Details -->
                <div class="bill-form-row">
                    <div class="bill-form-group">
                        <label><i class="fas fa-credit-card"></i> Payment Method</label>
                        <select id="billPaymentMethod">
                            <option value="cash">Cash</option>
                            <option value="card">Credit/Debit Card</option>
                            <option value="upi">UPI</option>
                            <option value="netbanking">Net Banking</option>
                            <option value="insurance">Insurance</option>
                        </select>
                    </div>
                    <div class="bill-form-group">
                        <label><i class="fas fa-check-circle"></i> Payment Status</label>
                        <select id="billPaymentStatus">
                            <option value="paid">Paid</option>
                            <option value="pending">Pending</option>
                            <option value="partial">Partial</option>
                        </select>
                    </div>
                </div>

                <div class="bill-form-group">
                    <label><i class="fas fa-sticky-note"></i> Notes</label>
                    <textarea id="billNotes" rows="2" placeholder="Any additional notes..."></textarea>
                </div>

                <!-- Actions -->
                <div class="bill-actions">
                    <button class="btn-preview" onclick="adminPortal.previewBill()">
                        <i class="fas fa-eye"></i> Preview
                    </button>
                    <button class="btn-generate" onclick="adminPortal.generateBillPDF()">
                        <i class="fas fa-download"></i> Download PDF
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification"></div>

    <script src="supabase-config.js"></script>
    <script>
        // Admin Portal Class
        class AdminPortal {
            constructor() {
                this.appointments = [];
                this.currentFilter = 'all';
                this.currentView = 'list';
                this.currentCalendarDate = new Date();
                this.sessionTimeout = 30 * 60 * 1000; // 30 minutes
                this.sessionTimer = null;
                this.isLoggedIn = false;
            }

            // Initialize
            async init() {
                // Check for existing session
                const sessionStart = localStorage.getItem('adminSessionStart');
                if (sessionStart && (Date.now() - parseInt(sessionStart)) < this.sessionTimeout) {
                    this.isLoggedIn = true;
                    this.showApp();
                    await this.loadAppointments();
                }
            }

            // Login
            login() {
                const password = document.getElementById('loginPassword').value;
                if (!password) {
                    this.showNotification('Please enter password', 'error');
                    return;
                }

                const hashedPassword = this.hashPassword(password);
                const storedHash = localStorage.getItem('adminPasswordHash') || this.hashPassword('admin123');

                if (hashedPassword === storedHash) {
                    this.isLoggedIn = true;
                    localStorage.setItem('adminSessionStart', Date.now().toString());
                    this.startSessionTimer();
                    this.showApp();
                    this.loadAppointments();
                    this.showNotification('Login successful!', 'success');
                } else {
                    this.showNotification('Invalid password', 'error');
                }
            }

            // Logout
            logout() {
                this.isLoggedIn = false;
                localStorage.removeItem('adminSessionStart');
                if (this.sessionTimer) clearTimeout(this.sessionTimer);
                document.getElementById('adminApp').style.display = 'none';
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('loginPassword').value = '';
                this.showNotification('Logged out successfully', 'info');
            }

            // Show App
            showApp() {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('adminApp').style.display = 'block';
            }

            // Start Session Timer
            startSessionTimer() {
                if (this.sessionTimer) clearTimeout(this.sessionTimer);
                this.sessionTimer = setTimeout(() => {
                    this.showNotification('Session expired. Please login again.', 'error');
                    this.logout();
                }, this.sessionTimeout);
            }

            // Hash Password
            hashPassword(password) {
                let hash = 0;
                const salt = 'ShalomDentalSecure2025';
                const combined = password + salt;
                for (let i = 0; i < combined.length; i++) {
                    const char = combined.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash;
                }
                return hash.toString(36);
            }

            // Change Password
            changePassword() {
                const currentPassword = prompt('Enter current password:');
                if (!currentPassword) return;

                const currentHash = this.hashPassword(currentPassword);
                const storedHash = localStorage.getItem('adminPasswordHash') || this.hashPassword('admin123');

                if (currentHash !== storedHash) {
                    this.showNotification('Current password is incorrect', 'error');
                    return;
                }

                const newPassword = prompt('Enter new password (min 6 characters):');
                if (!newPassword || newPassword.length < 6) {
                    this.showNotification('Password must be at least 6 characters', 'error');
                    return;
                }

                const confirmPassword = prompt('Confirm new password:');
                if (newPassword !== confirmPassword) {
                    this.showNotification('Passwords do not match', 'error');
                    return;
                }

                localStorage.setItem('adminPasswordHash', this.hashPassword(newPassword));
                this.showNotification('Password changed successfully!', 'success');
            }

            // Load Appointments
            async loadAppointments() {
                const statusEl = document.getElementById('connectionStatus');
                
                try {
                    // Try Supabase first
                    if (typeof supabaseClient !== 'undefined' && supabaseClient) {
                        const { data, error } = await supabaseClient
                            .from('appointments')
                            .select('*')
                            .order('created_at', { ascending: false });

                        if (!error && data) {
                            this.appointments = data.map(apt => ({
                                id: apt.id,
                                appointmentId: apt.appointment_id,
                                name: apt.name,
                                phone: apt.phone,
                                email: apt.email,
                                service: apt.service,
                                date: apt.appointment_date,
                                message: apt.message || apt.notes,
                                status: apt.status,
                                createdAt: apt.created_at,
                                updatedAt: apt.updated_at
                            }));

                            // Load billing data from Supabase and attach to appointments
                            await this.loadBillingFromSupabase();

                            statusEl.innerHTML = '<i class="fas fa-cloud"></i> <span>Supabase Connected</span>';
                            statusEl.style.background = '#10b981';
                        } else {
                            throw new Error('Supabase query failed');
                        }
                    } else {
                        throw new Error('Supabase not configured');
                    }
                } catch (error) {
                    console.log('Using local storage:', error);
                    this.loadFromLocalStorage();
                    statusEl.innerHTML = '<i class="fas fa-database"></i> <span>Local Storage</span>';
                    statusEl.style.background = '#f59e0b';
                }

                this.updateStats();
                this.renderAppointments();

                // Load feedback data and update badge count
                await this.loadFeedback();
                const badge = document.getElementById('feedbackBadgeCount');
                if (badge) badge.textContent = this.feedbackList.length;
            }

            // Load billing data from Supabase and attach to appointments
            async loadBillingFromSupabase() {
                try {
                    if (typeof supabaseClient === 'undefined' || !supabaseClient) return;

                    const { data: billingData, error } = await supabaseClient
                        .from('billing')
                        .select('*')
                        .order('updated_at', { ascending: false });

                    if (error) throw error;

                    if (billingData && billingData.length > 0) {
                        billingData.forEach(bill => {
                            const appointment = this.appointments.find(a => a.id === bill.appointment_id);
                            if (appointment) {
                                appointment.billing = {
                                    id: bill.id,
                                    consultFee: bill.consultant_fee || 0,
                                    labFee: bill.lab_fee || 0,
                                    clinicFee: bill.clinic_fee || 0,
                                    total: bill.total_fee || 0,
                                    billNumber: bill.bill_number,
                                    discountPercent: bill.discount_percent || 0,
                                    taxPercent: bill.tax_percent || 0,
                                    grandTotal: bill.grand_total || 0,
                                    paymentMethod: bill.payment_method || 'cash',
                                    paymentStatus: bill.payment_status || 'pending',
                                    billDate: bill.bill_date,
                                    notes: bill.notes,
                                    billGenerated: bill.bill_generated || false,
                                    updatedAt: bill.updated_at
                                };
                            }
                        });
                        console.log(`✅ Loaded billing data for ${billingData.length} appointments`);
                    }
                } catch (error) {
                    console.error('Failed to load billing from Supabase:', error);
                }
            }

            // Load from Local Storage
            loadFromLocalStorage() {
                try {
                    const encryptedData = localStorage.getItem('dentalAppointmentsSecure');
                    if (encryptedData) {
                        const key = this.getEncryptionKey();
                        const decoded = atob(encryptedData);
                        let result = '';
                        for (let i = 0; i < decoded.length; i++) {
                            const charCode = decoded.charCodeAt(i);
                            const keyChar = key.charCodeAt(i % key.length);
                            result += String.fromCharCode(charCode ^ keyChar);
                        }
                        this.appointments = JSON.parse(result);
                    }
                } catch (e) {
                    console.error('Failed to load from local storage:', e);
                    this.appointments = [];
                }
            }

            // Get Encryption Key
            getEncryptionKey() {
                const deviceInfo = navigator.userAgent + navigator.language + screen.width + screen.height;
                let hash = 0;
                for (let i = 0; i < deviceInfo.length; i++) {
                    const char = deviceInfo.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash;
                }
                return hash.toString(36) + 'ShalomDental2025';
            }

            // Update Stats
            updateStats() {
                const today = new Date().toISOString().split('T')[0];
                
                document.getElementById('pendingCount').textContent = 
                    this.appointments.filter(a => a.status === 'pending').length;
                document.getElementById('confirmedCount').textContent = 
                    this.appointments.filter(a => a.status === 'confirmed').length;
                document.getElementById('todayCount').textContent = 
                    this.appointments.filter(a => a.date === today).length;
                document.getElementById('totalCount').textContent = this.appointments.length;
            }

            // Render Appointments
            renderAppointments() {
                let filtered = this.currentFilter === 'all' 
                    ? this.appointments 
                    : this.appointments.filter(a => a.status === this.currentFilter);

                const searchQuery = document.getElementById('searchInput')?.value?.toLowerCase() || '';
                if (searchQuery) {
                    filtered = filtered.filter(a => 
                        a.name?.toLowerCase().includes(searchQuery) ||
                        a.phone?.includes(searchQuery) ||
                        a.email?.toLowerCase().includes(searchQuery) ||
                        a.appointmentId?.toLowerCase().includes(searchQuery)
                    );
                }

                const container = document.getElementById('appointmentsList');
                
                if (filtered.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-calendar-times"></i>
                            <h3>No appointments found</h3>
                            <p>Try adjusting your search or filter criteria</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = filtered.map(apt => `
                    <div class="appointment-card ${apt.status}">
                        <div class="appointment-header">
                            <span class="appointment-name">${apt.name}</span>
                            <span class="appointment-status ${apt.status}">${apt.status}</span>
                        </div>
                        <div class="appointment-details">
                            <div><i class="fas fa-id-badge"></i> ${apt.appointmentId || apt.appointment_id || 'N/A'}</div>
                            <div><i class="fas fa-phone"></i> ${apt.phone}</div>
                            <div><i class="fas fa-envelope"></i> ${apt.email}</div>
                            <div><i class="fas fa-calendar"></i> ${new Date(apt.date).toLocaleDateString()}</div>
                            <div><i class="fas fa-tooth"></i> ${apt.service}</div>
                            ${apt.message ? `<div><i class="fas fa-comment"></i> ${apt.message}</div>` : ''}
                        </div>
                        <div class="appointment-actions">
                            ${apt.status === 'pending' ? `
                                <button class="btn-confirm" onclick="adminPortal.updateStatus(${apt.id}, 'confirmed')">
                                    <i class="fas fa-check"></i> Confirm
                                </button>
                                <button class="btn-reschedule" onclick="adminPortal.reschedule(${apt.id})">
                                    <i class="fas fa-calendar-alt"></i> Reschedule
                                </button>
                                <button class="btn-cancel" onclick="adminPortal.updateStatus(${apt.id}, 'cancelled')">
                                    <i class="fas fa-times"></i> Cancel
                                </button>
                            ` : ''}
                            ${apt.status === 'confirmed' ? `
                                <button class="btn-complete" onclick="adminPortal.updateStatus(${apt.id}, 'completed')">
                                    <i class="fas fa-check-double"></i> Complete
                                </button>
                                <button class="btn-reschedule" onclick="adminPortal.reschedule(${apt.id})">
                                    <i class="fas fa-calendar-alt"></i> Reschedule
                                </button>
                                <button class="btn-cancel" onclick="adminPortal.updateStatus(${apt.id}, 'cancelled')">
                                    <i class="fas fa-times"></i> Cancel
                                </button>
                            ` : ''}
                            ${apt.status === 'completed' ? `
                                <button class="btn-generate" onclick="adminPortal.openBillModal(${apt.id})" style="background: #6366f1;">
                                    <i class="fas fa-file-invoice-dollar"></i> Generate Bill
                                </button>
                                <button class="btn-feedback" onclick="adminPortal.openQuickFeedback(${apt.id})" style="background: #f59e0b; color: white;">
                                    <i class="fas fa-comment-dots"></i> Feedback
                                </button>
                            ` : ''}
                            <button class="btn-secondary" onclick="adminPortal.openBillModal(${apt.id})" style="background: #6b7280; color: white;">
                                <i class="fas fa-file-invoice"></i> Bill
                            </button>
                            <button class="btn-sms" onclick="adminPortal.sendSMSNotification(${apt.id})" style="background: #3b82f6; color: white;">
                                <i class="fas fa-sms"></i> SMS
                            </button>
                        </div>
                        <div class="billing-calculator">
                            <h5><i class="fas fa-calculator"></i> Billing Calculator</h5>
                            <div class="billing-fields">
                                <div class="billing-field">
                                    <label>Consultant Fee</label>
                                    <input type="number" id="consultFee_${apt.id}" placeholder="₹ 0" min="0" 
                                        value="${apt.billing?.consultFee || ''}"
                                        oninput="adminPortal.calcTotal(${apt.id})">
                                </div>
                                <div class="billing-field">
                                    <label>Lab Fee</label>
                                    <input type="number" id="labFee_${apt.id}" placeholder="₹ 0" min="0" 
                                        value="${apt.billing?.labFee || ''}"
                                        oninput="adminPortal.calcTotal(${apt.id})">
                                </div>
                                <div class="billing-field">
                                    <label>Clinic Fee</label>
                                    <input type="number" id="clinicFee_${apt.id}" placeholder="₹ 0" min="0" 
                                        value="${apt.billing?.clinicFee || ''}"
                                        oninput="adminPortal.calcTotal(${apt.id})">
                                </div>
                                <div class="billing-field total-field">
                                    <label>Total</label>
                                    <input type="text" id="totalFee_${apt.id}" placeholder="₹ 0" readonly
                                        value="${apt.billing ? '₹ ' + ((apt.billing.consultFee || 0) + (apt.billing.labFee || 0) + (apt.billing.clinicFee || 0)) : ''}">
                                </div>
                            </div>
                            <div class="billing-submit-row">
                                <button class="btn-submit-billing" id="submitBilling_${apt.id}" onclick="adminPortal.submitBillingToSupabase(${apt.id})">
                                    <span class="spinner" id="billingSpinner_${apt.id}"></span>
                                    <i class="fas fa-cloud-upload-alt" id="billingIcon_${apt.id}"></i>
                                    <span id="billingBtnText_${apt.id}">Submit</span>
                                </button>
                            </div>
                        </div>
                        <div class="appointment-meta">
                            Created: ${new Date(apt.createdAt).toLocaleString()}
                            ${apt.updatedAt !== apt.createdAt ? ` | Updated: ${new Date(apt.updatedAt).toLocaleString()}` : ''}
                        </div>
                    </div>
                `).join('');
            }

            // Update Appointment Status
            async updateStatus(id, status) {
                const appointment = this.appointments.find(a => a.id === id);
                if (!appointment) return;

                try {
                    if (typeof supabaseClient !== 'undefined' && supabaseClient) {
                        const { error } = await supabaseClient
                            .from('appointments')
                            .update({ status: status, updated_at: new Date().toISOString() })
                            .eq('id', id);

                        if (error) throw error;
                    }

                    appointment.status = status;
                    appointment.updatedAt = new Date().toISOString();
                    this.saveToLocalStorage();
                    this.updateStats();
                    this.renderAppointments();
                    
                    if (this.currentView === 'calendar') {
                        this.renderCalendar();
                    }

                    this.showNotification(`Appointment ${status}!`, 'success');
                    
                    // Send WhatsApp notification to customer
                    this.sendWhatsAppNotification(appointment, status);
                    
                } catch (error) {
                    console.error('Failed to update:', error);
                    this.showNotification('Failed to update appointment', 'error');
                }
            }

            // Send WhatsApp Notification
            sendWhatsAppNotification(appointment, status) {
                const phone = appointment.phone.replace(/[^0-9]/g, ''); // Remove non-numeric characters
                const formattedPhone = phone.startsWith('91') ? phone : `91${phone}`; // Add India country code if not present
                
                const messages = {
                    confirmed: `🦷 *Shalom Dental Care*\n\nHello ${appointment.name}! ✅\n\nYour appointment has been *CONFIRMED*!\n\n📋 *Appointment Details:*\n• ID: ${appointment.appointmentId || appointment.appointment_id}\n• Date: ${new Date(appointment.date).toLocaleDateString('en-IN', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}\n• Service: ${appointment.service}\n\n📍 *Location:*\n76/2, Gandhi Road, Srinivasa Nagar\nNew Perungalathur, Chennai 600063\n\n⏰ Please arrive 15 minutes early.\n\n📞 For any changes, call: +91 86107 76477\n\nThank you for choosing Shalom Dental Care! 😊`,
                    
                    cancelled: `🦷 *Shalom Dental Care*\n\nHello ${appointment.name},\n\nYour appointment (ID: ${appointment.appointmentId || appointment.appointment_id}) scheduled for ${new Date(appointment.date).toLocaleDateString('en-IN')} has been *CANCELLED*.\n\nIf you'd like to reschedule, please:\n📞 Call: +91 86107 76477\n🌐 Visit: Our website\n\nWe hope to see you soon!\n\nBest regards,\nShalom Dental Care Team`,
                    
                    completed: `🦷 *Shalom Dental Care*\n\nHello ${appointment.name}! 🎉\n\nThank you for visiting us today!\n\nYour appointment has been marked as *COMPLETED*.\n\n💝 We hope you had a great experience!\n\n⭐ If you're satisfied with our service, please consider leaving us a review.\n\n📅 For your next appointment, call: +91 86107 76477\n\nTake care of your smile! 😁\n\nBest regards,\nShalom Dental Care Team`,
                    
                    pending: `🦷 *Shalom Dental Care*\n\nHello ${appointment.name},\n\nYour appointment request has been received!\n\n📋 *Details:*\n• ID: ${appointment.appointmentId || appointment.appointment_id}\n• Preferred Date: ${new Date(appointment.date).toLocaleDateString('en-IN')}\n• Service: ${appointment.service}\n\n⏳ Status: *PENDING CONFIRMATION*\n\nWe will contact you within 24 hours to confirm your appointment time.\n\n📞 Questions? Call: +91 86107 76477\n\nThank you!\nShalom Dental Care Team`
                };

                const message = messages[status];
                if (!message) return;

                const encodedMessage = encodeURIComponent(message);
                const whatsappUrl = `https://wa.me/${formattedPhone}?text=${encodedMessage}`;
                
                // Show confirmation dialog
                this.showWhatsAppConfirmation(appointment, status, whatsappUrl);
            }

            // ==================== BILLING CALCULATOR ====================

            // Calculate total fee for an appointment
            calcTotal(appointmentId) {
                const consultFee = parseFloat(document.getElementById(`consultFee_${appointmentId}`)?.value) || 0;
                const labFee = parseFloat(document.getElementById(`labFee_${appointmentId}`)?.value) || 0;
                const clinicFee = parseFloat(document.getElementById(`clinicFee_${appointmentId}`)?.value) || 0;
                const total = consultFee + labFee + clinicFee;

                const totalField = document.getElementById(`totalFee_${appointmentId}`);
                if (totalField) {
                    totalField.value = total > 0 ? `₹ ${total.toLocaleString('en-IN')}` : '';
                }

                // Auto-save billing to the appointment object
                this.saveBilling(appointmentId, consultFee, labFee, clinicFee, total);
            }

            // Save billing data to the appointment (localStorage only — no Supabase on every keystroke)
            saveBilling(appointmentId, consultFee, labFee, clinicFee, total) {
                const appointment = this.appointments.find(a => a.id === appointmentId);
                if (!appointment) return;

                appointment.billing = {
                    ...appointment.billing,
                    consultFee: consultFee || 0,
                    labFee: labFee || 0,
                    clinicFee: clinicFee || 0,
                    total: total || 0,
                    updatedAt: new Date().toISOString()
                };

                // Save to localStorage only (Supabase is saved via the Submit button)
                this.saveToLocalStorage();
            }

            // Save billing data to Supabase using upsert (prevents duplicates)
            async saveBillingToSupabase(appointmentId, consultFee, labFee, clinicFee, total) {
                if (typeof supabaseClient === 'undefined' || !supabaseClient) return;

                const billingData = {
                    appointment_id: appointmentId,
                    consultant_fee: consultFee || 0,
                    lab_fee: labFee || 0,
                    clinic_fee: clinicFee || 0,
                    total_fee: total || 0,
                    updated_at: new Date().toISOString(),
                    created_at: new Date().toISOString()
                };

                // Use upsert with appointment_id as the conflict target
                // This inserts if no row exists for this appointment_id, or updates if it does
                const { error } = await supabaseClient
                    .from('billing')
                    .upsert(billingData, { onConflict: 'appointment_id' });

                if (error) throw error;
                console.log('✅ Billing upserted to Supabase for appointment:', appointmentId);
            }

            // Explicit submit billing to Supabase (triggered by button)
            async submitBillingToSupabase(appointmentId) {
                const btn = document.getElementById(`submitBilling_${appointmentId}`);
                const spinner = document.getElementById(`billingSpinner_${appointmentId}`);
                const icon = document.getElementById(`billingIcon_${appointmentId}`);
                const btnText = document.getElementById(`billingBtnText_${appointmentId}`);

                const consultFee = parseFloat(document.getElementById(`consultFee_${appointmentId}`)?.value) || 0;
                const labFee = parseFloat(document.getElementById(`labFee_${appointmentId}`)?.value) || 0;
                const clinicFee = parseFloat(document.getElementById(`clinicFee_${appointmentId}`)?.value) || 0;
                const total = consultFee + labFee + clinicFee;

                if (total <= 0) {
                    this.showNotification('Please enter at least one fee before submitting.', 'error');
                    return;
                }

                // Show loading state
                if (btn) btn.disabled = true;
                if (spinner) spinner.style.display = 'inline-block';
                if (icon) icon.style.display = 'none';
                if (btnText) btnText.textContent = 'Saving…';

                try {
                    // Save to localStorage
                    this.saveBilling(appointmentId, consultFee, labFee, clinicFee, total);
                    // Save to Supabase (upsert — no duplicates)
                    await this.saveBillingToSupabase(appointmentId, consultFee, labFee, clinicFee, total);
                    this.showNotification(`Billing for appointment #${appointmentId} saved to Supabase! Total: ₹${total.toLocaleString('en-IN')}`, 'success');

                    // Success state briefly
                    if (icon) { icon.className = 'fas fa-check'; icon.style.display = 'inline-block'; }
                    if (btnText) btnText.textContent = 'Saved!';
                    if (spinner) spinner.style.display = 'none';

                    setTimeout(() => {
                        if (icon) icon.className = 'fas fa-cloud-upload-alt';
                        if (btnText) btnText.textContent = 'Submit';
                        if (btn) btn.disabled = false;
                    }, 2000);

                } catch (error) {
                    console.error('Explicit billing save failed:', error);
                    this.showNotification('Failed to save billing to Supabase. Check console for details.', 'error');

                    if (icon) { icon.className = 'fas fa-exclamation-triangle'; icon.style.display = 'inline-block'; }
                    if (btnText) btnText.textContent = 'Retry';
                    if (spinner) spinner.style.display = 'none';
                    if (btn) btn.disabled = false;
                }
            }

            // ==================== END BILLING CALCULATOR ====================

            // Send SMS Notification
            sendSMSNotification(appointmentId) {
                const appointment = this.appointments.find(a => a.id === appointmentId);
                if (!appointment) {
                    this.showNotification('Appointment not found', 'error');
                    return;
                }

                // Show SMS options dialog
                this.showSMSOptionsDialog(appointment);
            }

            // Show SMS Options Dialog
            showSMSOptionsDialog(appointment) {
                // Remove existing dialog if any
                const existingDialog = document.getElementById('smsDialog');
                if (existingDialog) existingDialog.remove();

                const phone = appointment.phone.replace(/[^0-9]/g, '');
                
                // Predefined message templates
                const messageTemplates = {
                    reminder: `Shalom Dental Care: Hi ${appointment.name}, this is a reminder for your dental appointment on ${new Date(appointment.date).toLocaleDateString('en-IN')}. Please arrive 15 mins early. Call 8610776477 for queries.`,
                    
                    followup: `Shalom Dental Care: Hi ${appointment.name}, we hope you're doing well after your recent visit! If you have any concerns, please call us at 8610776477. Thank you!`,
                    
                    thankYou: `Shalom Dental Care: Thank you ${appointment.name} for visiting us! We appreciate your trust in us. For future appointments, call 8610776477 or visit our website.`,
                    
                    nextVisit: `Shalom Dental Care: Hi ${appointment.name}, it's time for your routine dental checkup. Book your appointment today! Call 8610776477 or visit our clinic.`,
                    
                    confirmation: `Shalom Dental Care: Hi ${appointment.name}, your appointment is CONFIRMED for ${new Date(appointment.date).toLocaleDateString('en-IN')}. Service: ${appointment.service}. Location: 76/2, Gandhi Road, New Perungalathur, Chennai.`,
                    
                    custom: ''
                };

                const dialog = document.createElement('div');
                dialog.id = 'smsDialog';
                dialog.innerHTML = `
                    <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); z-index: 2000; display: flex; justify-content: center; align-items: center; padding: 1rem;">
                        <div style="background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 20px; max-width: 500px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 80px rgba(0,0,0,0.25);">
                            <div style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.9), rgba(37, 99, 235, 0.95)); color: white; padding: 1.5rem 2rem; border-radius: 20px 20px 0 0; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                <h3 style="display: flex; align-items: center; gap: 0.75rem; font-size: 1.2rem; margin: 0;">
                                    <i class="fas fa-sms"></i> Send SMS
                                </h3>
                                <button onclick="document.getElementById('smsDialog').remove()" style="background: rgba(255,255,255,0.2); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.3); color: white; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 1.2rem;">×</button>
                            </div>
                            <div style="padding: 1.5rem; background: rgba(255,255,255,0.3);">
                                <div style="background: rgba(240, 249, 255, 0.8); backdrop-filter: blur(10px); padding: 1rem; border-radius: 12px; margin-bottom: 1.5rem; border: 1px solid rgba(59, 130, 246, 0.2);">
                                    <div style="font-size: 0.9rem; color: #374151;">
                                        <div><strong>Patient:</strong> ${appointment.name}</div>
                                        <div><strong>Phone:</strong> ${appointment.phone}</div>
                                        <div><strong>Appointment:</strong> ${new Date(appointment.date).toLocaleDateString('en-IN')}</div>
                                    </div>
                                </div>

                                <div style="margin-bottom: 1rem;">
                                    <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Select Message Type</label>
                                    <select id="smsTemplateSelect" onchange="adminPortal.updateSMSPreview()" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem;">
                                        <option value="reminder">📅 Appointment Reminder</option>
                                        <option value="confirmation">✅ Confirmation</option>
                                        <option value="followup">🩺 Follow-up</option>
                                        <option value="thankYou">🙏 Thank You</option>
                                        <option value="nextVisit">🔔 Next Visit Reminder</option>
                                        <option value="custom">✏️ Custom Message</option>
                                    </select>
                                </div>

                                <div style="margin-bottom: 1rem;">
                                    <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Message Preview</label>
                                    <textarea id="smsMessagePreview" rows="5" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.95rem; resize: vertical;">${messageTemplates.reminder}</textarea>
                                    <div style="font-size: 0.8rem; color: #6b7280; margin-top: 0.5rem;">
                                        <span id="smsCharCount">0</span>/160 characters (1 SMS = 160 chars)
                                    </div>
                                </div>

                                <div style="display: flex; gap: 1rem; justify-content: flex-end; padding-top: 1rem; border-top: 1px solid #e5e7eb;">
                                    <button onclick="document.getElementById('smsDialog').remove()" style="padding: 0.75rem 1.5rem; background: #f3f4f6; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; color: #374151;">
                                        Cancel
                                    </button>
                                    <button onclick="adminPortal.openSMSApp('${phone}')" style="padding: 0.75rem 1.5rem; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                                        <i class="fas fa-paper-plane"></i> Open SMS App
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(dialog);

                // Store templates for later use
                this.currentSMSTemplates = messageTemplates;
                this.currentSMSPhone = phone;
                this.currentSMSAppointment = appointment;

                // Update character count
                this.updateSMSCharCount();
                document.getElementById('smsMessagePreview').addEventListener('input', () => this.updateSMSCharCount());
            }

            // Update SMS Preview based on selected template
            updateSMSPreview() {
                const select = document.getElementById('smsTemplateSelect');
                const textarea = document.getElementById('smsMessagePreview');
                const selectedTemplate = select.value;
                
                if (selectedTemplate !== 'custom' && this.currentSMSTemplates) {
                    textarea.value = this.currentSMSTemplates[selectedTemplate];
                }
                
                this.updateSMSCharCount();
            }

            // Update SMS character count
            updateSMSCharCount() {
                const textarea = document.getElementById('smsMessagePreview');
                const charCount = document.getElementById('smsCharCount');
                if (textarea && charCount) {
                    const length = textarea.value.length;
                    charCount.textContent = length;
                    charCount.style.color = length > 160 ? '#ef4444' : '#6b7280';
                }
            }

            // Open SMS App with message
            openSMSApp(phone) {
                const message = document.getElementById('smsMessagePreview').value;
                if (!message.trim()) {
                    this.showNotification('Please enter a message', 'error');
                    return;
                }

                // Format phone number (add country code if needed)
                const formattedPhone = phone.startsWith('91') ? `+${phone}` : `+91${phone}`;
                
                // Create SMS URL - works on mobile devices and some desktops
                // Different formats for different platforms
                const encodedMessage = encodeURIComponent(message);
                
                // Try different SMS URI formats
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
                const smsUrl = isIOS 
                    ? `sms:${formattedPhone}&body=${encodedMessage}`  // iOS format
                    : `sms:${formattedPhone}?body=${encodedMessage}`; // Android/Desktop format

                // Open SMS app
                window.location.href = smsUrl;

                // Close dialog after short delay
                setTimeout(() => {
                    const dialog = document.getElementById('smsDialog');
                    if (dialog) dialog.remove();
                    this.showNotification('SMS app opened! Send the message manually.', 'info');
                }, 500);
            }

            // Show WhatsApp Confirmation Dialog
            showWhatsAppConfirmation(appointment, status, whatsappUrl) {
                // Remove existing dialog if any
                const existingDialog = document.getElementById('whatsappDialog');
                if (existingDialog) existingDialog.remove();

                const statusColors = {
                    confirmed: '#10b981',
                    cancelled: '#ef4444',
                    completed: '#6366f1',
                    pending: '#f59e0b'
                };

                const dialog = document.createElement('div');
                dialog.id = 'whatsappDialog';
                dialog.innerHTML = `
                    <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); z-index: 2000; display: flex; justify-content: center; align-items: center;">
                        <div style="background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 20px; padding: 2rem; max-width: 400px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.2); text-align: center;">
                            <div style="width: 60px; height: 60px; background: linear-gradient(135deg, rgba(37, 211, 102, 0.9), rgba(30, 170, 80, 0.95)); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem; border: 1px solid rgba(37, 211, 102, 0.3); box-shadow: 0 8px 25px rgba(37, 211, 102, 0.3);">
                                <i class="fab fa-whatsapp" style="font-size: 2rem; color: white;"></i>
                            </div>
                            <h3 style="margin-bottom: 0.5rem; color: #374151;">Send WhatsApp Message?</h3>
                            <p style="color: #6b7280; margin-bottom: 1rem; font-size: 0.9rem;">
                                Notify <strong>${appointment.name}</strong> about their appointment status change to <span style="color: ${statusColors[status]}; font-weight: 600;">${status.toUpperCase()}</span>
                            </p>
                            <div style="background: rgba(243, 244, 246, 0.8); backdrop-filter: blur(10px); padding: 1rem; border-radius: 12px; margin-bottom: 1.5rem; text-align: left; border: 1px solid rgba(0,0,0,0.05);">
                                <div style="font-size: 0.85rem; color: #6b7280;">
                                    <div><strong>Phone:</strong> ${appointment.phone}</div>
                                    <div><strong>Date:</strong> ${new Date(appointment.date).toLocaleDateString()}</div>
                                </div>
                            </div>
                            <div style="display: flex; gap: 1rem; justify-content: center;">
                                <button onclick="document.getElementById('whatsappDialog').remove()" style="padding: 0.75rem 1.5rem; background: rgba(243, 244, 246, 0.8); backdrop-filter: blur(10px); border: 1px solid rgba(0,0,0,0.1); border-radius: 10px; cursor: pointer; font-weight: 500; color: #374151;">
                                    Skip
                                </button>
                                <button onclick="window.open('${whatsappUrl}', '_blank'); document.getElementById('whatsappDialog').remove();" style="padding: 0.75rem 1.5rem; background: #25D366; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; display: flex; align-items: center; gap: 0.5rem;">
                                    <i class="fab fa-whatsapp"></i> Send Message
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(dialog);

                // Auto-close after 10 seconds
                setTimeout(() => {
                    const dialogEl = document.getElementById('whatsappDialog');
                    if (dialogEl) dialogEl.remove();
                }, 10000);
            }

            // Reschedule Appointment
            async reschedule(id) {
                const newDate = prompt('Enter new date (YYYY-MM-DD):');
                if (!newDate) return;

                const appointment = this.appointments.find(a => a.id === id);
                if (!appointment) return;
                
                const oldDate = appointment.date;

                try {
                    if (typeof supabaseClient !== 'undefined' && supabaseClient) {
                        const { error } = await supabaseClient
                            .from('appointments')
                            .update({ appointment_date: newDate, updated_at: new Date().toISOString() })
                            .eq('id', id);

                        if (error) throw error;
                    }

                    appointment.date = newDate;
                    appointment.updatedAt = new Date().toISOString();
                    this.saveToLocalStorage();
                    this.updateStats();
                    this.renderAppointments();
                    
                    if (this.currentView === 'calendar') {
                        this.renderCalendar();
                    }

                    this.showNotification('Appointment rescheduled!', 'success');
                    
                    // Send WhatsApp notification for reschedule
                    this.sendRescheduleWhatsApp(appointment, oldDate, newDate);
                    
                } catch (error) {
                    console.error('Failed to reschedule:', error);
                    this.showNotification('Failed to reschedule', 'error');
                }
            }

            // Send Reschedule WhatsApp Notification
            sendRescheduleWhatsApp(appointment, oldDate, newDate) {
                const phone = appointment.phone.replace(/[^0-9]/g, '');
                const formattedPhone = phone.startsWith('91') ? phone : `91${phone}`;
                
                const message = `🦷 *Shalom Dental Care*\n\nHello ${appointment.name}! 📅\n\nYour appointment has been *RESCHEDULED*.\n\n📋 *Updated Details:*\n• ID: ${appointment.appointmentId || appointment.appointment_id}\n• Previous Date: ${new Date(oldDate).toLocaleDateString('en-IN', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}\n• *New Date: ${new Date(newDate).toLocaleDateString('en-IN', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}*\n• Service: ${appointment.service}\n\n📍 *Location:*\n76/2, Gandhi Road, Srinivasa Nagar\nNew Perungalathur, Chennai 600063\n\n⏰ Please arrive 15 minutes early.\n\n📞 For any changes, call: +91 86107 76477\n\nThank you!\nShalom Dental Care Team`;

                const encodedMessage = encodeURIComponent(message);
                const whatsappUrl = `https://wa.me/${formattedPhone}?text=${encodedMessage}`;
                
                // Show confirmation dialog
                this.showRescheduleWhatsAppConfirmation(appointment, oldDate, newDate, whatsappUrl);
            }

            // Show Reschedule WhatsApp Confirmation
            showRescheduleWhatsAppConfirmation(appointment, oldDate, newDate, whatsappUrl) {
                const existingDialog = document.getElementById('whatsappDialog');
                if (existingDialog) existingDialog.remove();

                const dialog = document.createElement('div');
                dialog.id = 'whatsappDialog';
                dialog.innerHTML = `
                    <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); z-index: 2000; display: flex; justify-content: center; align-items: center;">
                        <div style="background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 20px; padding: 2rem; max-width: 400px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.2); text-align: center;">
                            <div style="width: 60px; height: 60px; background: linear-gradient(135deg, rgba(37, 211, 102, 0.9), rgba(30, 170, 80, 0.95)); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem; border: 1px solid rgba(37, 211, 102, 0.3); box-shadow: 0 8px 25px rgba(37, 211, 102, 0.3);">
                                <i class="fab fa-whatsapp" style="font-size: 2rem; color: white;"></i>
                            </div>
                            <h3 style="margin-bottom: 0.5rem; color: #374151;">Send Reschedule Notification?</h3>
                            <p style="color: #6b7280; margin-bottom: 1rem; font-size: 0.9rem;">
                                Notify <strong>${appointment.name}</strong> about the new appointment date
                            </p>
                            <div style="background: rgba(243, 244, 246, 0.8); backdrop-filter: blur(10px); padding: 1rem; border-radius: 12px; margin-bottom: 1.5rem; text-align: left; border: 1px solid rgba(0,0,0,0.05);">
                                <div style="font-size: 0.85rem; color: #6b7280;">
                                    <div><strong>Phone:</strong> ${appointment.phone}</div>
                                    <div style="text-decoration: line-through; color: #9ca3af;"><strong>Old Date:</strong> ${new Date(oldDate).toLocaleDateString()}</div>
                                    <div style="color: #10b981; font-weight: 600;"><strong>New Date:</strong> ${new Date(newDate).toLocaleDateString()}</div>
                                </div>
                            </div>
                            <div style="display: flex; gap: 1rem; justify-content: center;">
                                <button onclick="document.getElementById('whatsappDialog').remove()" style="padding: 0.75rem 1.5rem; background: rgba(243, 244, 246, 0.8); backdrop-filter: blur(10px); border: 1px solid rgba(0,0,0,0.1); border-radius: 10px; cursor: pointer; font-weight: 500; color: #374151;">
                                    Skip
                                </button>
                                <button onclick="window.open('${whatsappUrl}', '_blank'); document.getElementById('whatsappDialog').remove();" style="padding: 0.75rem 1.5rem; background: linear-gradient(135deg, rgba(37, 211, 102, 0.9), rgba(30, 170, 80, 0.95)); color: white; border: 1px solid rgba(37, 211, 102, 0.3); border-radius: 10px; cursor: pointer; font-weight: 500; display: flex; align-items: center; gap: 0.5rem; box-shadow: 0 4px 15px rgba(37, 211, 102, 0.3);">
                                    <i class="fab fa-whatsapp"></i> Send Message
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(dialog);

                setTimeout(() => {
                    const dialogEl = document.getElementById('whatsappDialog');
                    if (dialogEl) dialogEl.remove();
                }, 10000);
            }

            // Save to Local Storage
            saveToLocalStorage() {
                try {
                    const key = this.getEncryptionKey();
                    const jsonData = JSON.stringify(this.appointments);
                    let result = '';
                    for (let i = 0; i < jsonData.length; i++) {
                        const charCode = jsonData.charCodeAt(i);
                        const keyChar = key.charCodeAt(i % key.length);
                        result += String.fromCharCode(charCode ^ keyChar);
                    }
                    localStorage.setItem('dentalAppointmentsSecure', btoa(result));
                } catch (e) {
                    console.error('Failed to save:', e);
                }
            }

            // Filter
            filter(status, element) {
                this.currentFilter = status;
                document.querySelectorAll('.filter-tab').forEach(tab => tab.classList.remove('active'));
                element.classList.add('active');
                this.renderAppointments();
            }

            // Search
            search(query) {
                this.renderAppointments();
            }

            // Switch View
            switchView(view, element) {
                this.currentView = view;
                
                // Deactivate all quick-action buttons
                document.querySelectorAll('.quick-action-btn').forEach(btn => btn.classList.remove('active'));

                // Activate the clicked element
                if (element) element.classList.add('active');

                // Hide all views first
                document.getElementById('listView').style.display = 'none';
                document.getElementById('calendarView').style.display = 'none';
                document.getElementById('analyticsView').style.display = 'none';
                document.getElementById('feedbackView').style.display = 'none';
                document.getElementById('filterTabs').style.display = 'none';
                
                // Get elements
                const contentArea = document.querySelector('.content-area');
                const controlsSection = document.getElementById('controlsSection');

                if (view === 'calendar') {
                    controlsSection.style.display = 'none';
                    contentArea.style.display = 'block';
                    document.getElementById('calendarView').style.display = 'block';
                    this.renderCalendar();
                } else if (view === 'analytics') {
                    controlsSection.style.display = 'none';
                    contentArea.style.display = 'block';
                    document.getElementById('analyticsView').style.display = 'block';
                    this.renderAnalytics();
                } else if (view === 'feedback') {
                    controlsSection.style.display = 'none';
                    contentArea.style.display = 'none';
                    document.getElementById('feedbackView').style.display = 'block';
                    this.renderFeedbackView();
                } else {
                    // List view (Appointments)
                    controlsSection.style.display = 'block';
                    contentArea.style.display = 'block';
                    document.getElementById('listView').style.display = 'block';
                    document.getElementById('filterTabs').style.display = 'flex';
                }
            }

            // Calendar Methods
            renderCalendar() {
                const calendarGrid = document.getElementById('calendarGrid');
                const monthYearLabel = document.getElementById('calendarMonthYear');

                const year = this.currentCalendarDate.getFullYear();
                const month = this.currentCalendarDate.getMonth();

                const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                                   'July', 'August', 'September', 'October', 'November', 'December'];
                monthYearLabel.textContent = `${monthNames[month]} ${year}`;

                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const today = new Date().toISOString().split('T')[0];

                const appointmentsByDate = {};
                this.appointments.forEach(apt => {
                    const aptDate = new Date(apt.date);
                    if (aptDate.getFullYear() === year && aptDate.getMonth() === month) {
                        if (!appointmentsByDate[apt.date]) {
                            appointmentsByDate[apt.date] = [];
                        }
                        appointmentsByDate[apt.date].push(apt);
                    }
                });

                let html = `
                    <div class="calendar-weekdays">
                        <div>Sun</div>
                        <div>Mon</div>
                        <div>Tue</div>
                        <div>Wed</div>
                        <div>Thu</div>
                        <div>Fri</div>
                        <div>Sat</div>
                    </div>
                    <div class="calendar-days">
                `;

                for (let i = 0; i < firstDay; i++) {
                    html += '<div class="calendar-day empty"></div>';
                }

                for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const dayAppointments = appointmentsByDate[dateStr] || [];
                    const isToday = dateStr === today;
                    const hasAppointments = dayAppointments.length > 0;

                    let badges = '';
                    if (hasAppointments) {
                        const pending = dayAppointments.filter(a => a.status === 'pending').length;
                        const confirmed = dayAppointments.filter(a => a.status === 'confirmed').length;
                        const completed = dayAppointments.filter(a => a.status === 'completed').length;
                        const cancelled = dayAppointments.filter(a => a.status === 'cancelled').length;

                        if (pending) badges += `<span class="calendar-badge pending">${pending}</span>`;
                        if (confirmed) badges += `<span class="calendar-badge confirmed">${confirmed}</span>`;
                        if (completed) badges += `<span class="calendar-badge completed">${completed}</span>`;
                        if (cancelled) badges += `<span class="calendar-badge cancelled">${cancelled}</span>`;
                    }

                    html += `
                        <div class="calendar-day ${isToday ? 'today' : ''} ${hasAppointments ? 'has-appointments' : ''}"
                             onclick="adminPortal.showDayModal('${dateStr}')">
                            <span class="day-number">${day}</span>
                            ${hasAppointments ? `
                                <div class="appointment-count">${dayAppointments.length} apt${dayAppointments.length > 1 ? 's' : ''}</div>
                                <div class="calendar-badges">${badges}</div>
                            ` : ''}
                        </div>
                    `;
                }

                html += '</div>';
                calendarGrid.innerHTML = html;
            }

            previousMonth() {
                this.currentCalendarDate.setMonth(this.currentCalendarDate.getMonth() - 1);
                this.renderCalendar();
            }

            nextMonth() {
                this.currentCalendarDate.setMonth(this.currentCalendarDate.getMonth() + 1);
                this.renderCalendar();
            }

            goToToday() {
                this.currentCalendarDate = new Date();
                this.renderCalendar();
            }

            showDayModal(dateStr) {
                const dayAppointments = this.appointments.filter(a => a.date === dateStr);
                const dateObj = new Date(dateStr);
                const formattedDate = dateObj.toLocaleDateString('en-US', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });

                document.getElementById('modalDate').textContent = formattedDate;
                
                const container = document.getElementById('modalAppointments');
                if (dayAppointments.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-calendar-times"></i>
                            <h3>No appointments</h3>
                            <p>No appointments scheduled for this day</p>
                        </div>
                    `;
                } else {
                    container.innerHTML = dayAppointments.map(apt => `
                        <div class="day-appointment ${apt.status}">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <strong>${apt.name}</strong>
                                <span class="appointment-status ${apt.status}" style="font-size: 0.7rem; padding: 0.2rem 0.5rem;">${apt.status}</span>
                            </div>
                            <div style="font-size: 0.85rem; color: #6b7280; line-height: 1.6;">
                                <div><i class="fas fa-phone" style="width: 16px;"></i> ${apt.phone}</div>
                                <div><i class="fas fa-tooth" style="width: 16px;"></i> ${apt.service}</div>
                                <div><i class="fas fa-id-badge" style="width: 16px;"></i> ${apt.appointmentId || apt.appointment_id}</div>
                            </div>
                            <div style="margin-top: 0.75rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                ${apt.status === 'pending' ? `
                                    <button class="btn-confirm" style="padding: 0.4rem 0.8rem; font-size: 0.8rem;" 
                                            onclick="adminPortal.updateStatus(${apt.id}, 'confirmed'); adminPortal.showDayModal('${dateStr}');">
                                        <i class="fas fa-check"></i> Confirm
                                    </button>
                                    <button class="btn-cancel" style="padding: 0.4rem 0.8rem; font-size: 0.8rem;" 
                                            onclick="adminPortal.updateStatus(${apt.id}, 'cancelled'); adminPortal.showDayModal('${dateStr}');">
                                        <i class="fas fa-times"></i> Cancel
                                    </button>
                                ` : ''}
                                ${apt.status === 'confirmed' ? `
                                    <button class="btn-complete" style="padding: 0.4rem 0.8rem; font-size: 0.8rem;" 
                                            onclick="adminPortal.updateStatus(${apt.id}, 'completed'); adminPortal.showDayModal('${dateStr}');">
                                        <i class="fas fa-check-double"></i> Complete
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    `).join('');
                }

                document.getElementById('dayModal').classList.add('active');
            }

            closeModal() {
                document.getElementById('dayModal').classList.remove('active');
                this.renderCalendar();
            }

            // Sync Data
            async syncData() {
                this.showNotification('Syncing data...', 'info');
                await this.loadAppointments();
                this.showNotification('Data synced successfully!', 'success');
            }

            // Export CSV
            exportCSV() {
                const csvContent = [
                    ['Date Created', 'Appointment ID', 'Name', 'Phone', 'Email', 'Service', 'Appointment Date', 'Status', 'Message'].join(','),
                    ...this.appointments.map(a => [
                        new Date(a.createdAt).toLocaleDateString(),
                        a.appointmentId || a.appointment_id,
                        `"${a.name}"`,
                        a.phone,
                        a.email,
                        `"${a.service}"`,
                        a.date,
                        a.status,
                        `"${a.message || ''}"`
                    ].join(','))
                ].join('\n');

                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `shalom-dental-appointments-${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                this.showNotification('CSV exported successfully!', 'success');
            }

            // Show Notification
            showNotification(message, type = 'info') {
                const notification = document.getElementById('notification');
                notification.textContent = message;
                notification.className = `notification ${type} show`;

                setTimeout(() => {
                    notification.classList.remove('show');
                }, 3000);
            }

            // ==================== BILL GENERATION METHODS ====================

            // Generate unique bill number
            generateBillNumber() {
                const date = new Date();
                const year = date.getFullYear().toString().slice(-2);
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const random = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
                return `SDC${year}${month}${random}`;
            }

            // Open Bill Modal
            openBillModal(appointmentId) {
                const appointment = this.appointments.find(a => a.id === appointmentId);
                if (!appointment) {
                    this.showNotification('Appointment not found', 'error');
                    return;
                }

                // Store current appointment for bill
                this.currentBillAppointment = appointment;

                // Populate form fields
                document.getElementById('billAppointmentId').value = appointmentId;
                document.getElementById('billPatientName').value = appointment.name;
                document.getElementById('billPatientPhone').value = appointment.phone;
                document.getElementById('billPatientEmail').value = appointment.email || '';
                document.getElementById('billAppointmentDate').value = new Date(appointment.date).toLocaleDateString('en-IN');
                document.getElementById('billNumber').value = this.generateBillNumber();
                document.getElementById('billDate').value = new Date().toISOString().split('T')[0];
                document.getElementById('billDiscount').value = 0;
                document.getElementById('billTax').value = 0;
                document.getElementById('billNotes').value = '';

                // Clear bill items
                this.billItems = [];

                // Check if billing calculator data exists for this appointment
                const billing = appointment.billing;
                const hasBillingData = billing && (billing.consultFee > 0 || billing.labFee > 0 || billing.clinicFee > 0);

                if (hasBillingData) {
                    // Use billing calculator total as a single "General Check Up" line item
                    const totalAmount = (billing.consultFee || 0) + (billing.labFee || 0) + (billing.clinicFee || 0);
                    this.addBillItem('General Check Up', 1, totalAmount);
                } else {
                    // Fallback: use default service price
                    const servicePrice = this.getServicePrice(appointment.service);
                    this.addBillItem(appointment.service, 1, servicePrice);
                }

                // Show modal
                document.getElementById('billModal').classList.add('active');
            }

            // Get default price for service
            getServicePrice(service) {
                const prices = {
                    'general': 500,
                    'General Checkup': 500,
                    'cleaning': 1500,
                    'Teeth Cleaning': 1500,
                    'cosmetic': 2000,
                    'Cosmetic Consultation': 2000,
                    'emergency': 1000,
                    'Emergency Care': 1000,
                    'root_canal': 8000,
                    'Root Canal': 8000,
                    'extraction': 2000,
                    'Extraction': 2000,
                    'filling': 1500,
                    'Filling': 1500,
                    'crown': 15000,
                    'Crown': 15000,
                    'dentures': 25000,
                    'Dentures': 25000,
                    'braces': 50000,
                    'Braces': 50000,
                    'whitening': 8000,
                    'Whitening': 8000,
                    'implant': 35000,
                    'Implant': 35000
                };
                return prices[service] || 500;
            }

            // Close Bill Modal
            closeBillModal() {
                document.getElementById('billModal').classList.remove('active');
                this.billItems = [];
                this.currentBillAppointment = null;
            }

            // Bill items array
            billItems = [];

            // Add Bill Item
            addBillItem(description = '', quantity = 1, rate = 0) {
                const item = {
                    id: Date.now(),
                    description: description,
                    quantity: quantity,
                    rate: rate
                };
                this.billItems.push(item);
                this.renderBillItems();
                this.calculateBillTotal();
            }

            // Remove Bill Item
            removeBillItem(itemId) {
                this.billItems = this.billItems.filter(item => item.id !== itemId);
                this.renderBillItems();
                this.calculateBillTotal();
            }

            // Render Bill Items
            renderBillItems() {
                const container = document.getElementById('billItemsContainer');
                
                if (this.billItems.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: #9ca3af;">
                            <i class="fas fa-receipt" style="font-size: 2rem; margin-bottom: 0.5rem;"></i>
                            <p>No items added yet. Click "Add Item" to start.</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = this.billItems.map(item => `
                    <div class="bill-item" data-id="${item.id}">
                        <input type="text" value="${item.description}" placeholder="Service/Item description" 
                               onchange="adminPortal.updateBillItem(${item.id}, 'description', this.value)">
                        <input type="number" value="${item.quantity}" min="1" 
                               onchange="adminPortal.updateBillItem(${item.id}, 'quantity', this.value)">
                        <input type="number" value="${item.rate}" min="0" step="0.01"
                               onchange="adminPortal.updateBillItem(${item.id}, 'rate', this.value)">
                        <input type="text" value="₹${(item.quantity * item.rate).toFixed(2)}" readonly 
                               style="background: #f3f4f6; font-weight: 600;">
                        <button class="remove-item-btn" onclick="adminPortal.removeBillItem(${item.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `).join('');
            }

            // Update Bill Item
            updateBillItem(itemId, field, value) {
                const item = this.billItems.find(i => i.id === itemId);
                if (item) {
                    if (field === 'quantity' || field === 'rate') {
                        item[field] = parseFloat(value) || 0;
                    } else {
                        item[field] = value;
                    }
                    this.renderBillItems();
                    this.calculateBillTotal();
                }
            }

            // Calculate Bill Total
            calculateBillTotal() {
                const subtotal = this.billItems.reduce((sum, item) => sum + (item.quantity * item.rate), 0);
                const discountPercent = parseFloat(document.getElementById('billDiscount').value) || 0;
                const taxPercent = parseFloat(document.getElementById('billTax').value) || 0;

                const discountAmount = subtotal * (discountPercent / 100);
                const afterDiscount = subtotal - discountAmount;
                const taxAmount = afterDiscount * (taxPercent / 100);
                const grandTotal = afterDiscount + taxAmount;

                document.getElementById('billSubtotal').textContent = `₹${subtotal.toFixed(2)}`;
                document.getElementById('billGrandTotal').textContent = `₹${grandTotal.toFixed(2)}`;

                return { subtotal, discountAmount, taxAmount, grandTotal };
            }

            // Preview Bill
            previewBill() {
                this.generateBillPDF(true);
            }

            // Generate Bill PDF
            async generateBillPDF(previewOnly = false) {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                const billNumber = document.getElementById('billNumber').value;
                const billDate = document.getElementById('billDate').value;
                const patientName = document.getElementById('billPatientName').value;
                const patientPhone = document.getElementById('billPatientPhone').value;
                const patientEmail = document.getElementById('billPatientEmail').value;
                const appointmentDate = document.getElementById('billAppointmentDate').value;
                const paymentMethod = document.getElementById('billPaymentMethod').value;
                const paymentStatus = document.getElementById('billPaymentStatus').value;
                const notes = document.getElementById('billNotes').value;
                const discountPercent = parseFloat(document.getElementById('billDiscount').value) || 0;
                const taxPercent = parseFloat(document.getElementById('billTax').value) || 0;

                const { subtotal, discountAmount, taxAmount, grandTotal } = this.calculateBillTotal();

                // Colors
                const primaryBlue = [37, 99, 235];
                const darkGray = [55, 65, 81];
                const mediumGray = [107, 114, 128];
                const lightBlue = [239, 246, 255];

                // Header Background
                doc.setFillColor(...primaryBlue);
                doc.rect(0, 0, 210, 45, 'F');

                // Clinic Logo/Name
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(24);
                doc.setFont('helvetica', 'bold');
                doc.text('Shalom Dental Care', 20, 20);

                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text('76/2, Gandhi Road, Srinivasa Nagar', 20, 28);
                doc.text('New Perungalathur, Chennai - 600063', 20, 34);
                doc.text('Phone: +91 86107 76477', 20, 40);

                // Bill Title
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text('INVOICE', 160, 20);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text(`#${billNumber}`, 160, 28);
                doc.text(`Date: ${new Date(billDate).toLocaleDateString('en-IN')}`, 160, 36);

                // Patient Details Section
                let yPos = 55;
                
                doc.setFillColor(...lightBlue);
                doc.rect(15, yPos, 180, 30, 'F');
                
                doc.setTextColor(...darkGray);
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.text('BILL TO:', 20, yPos + 8);
                
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(10);
                doc.text(`${patientName}`, 20, yPos + 16);
                doc.text(`Phone: ${patientPhone}`, 20, yPos + 23);
                
                if (patientEmail) {
                    doc.text(`Email: ${patientEmail}`, 100, yPos + 16);
                }
                doc.text(`Appointment Date: ${appointmentDate}`, 100, yPos + 23);

                // Items Table Header
                yPos = 95;
                doc.setFillColor(...primaryBlue);
                doc.rect(15, yPos, 180, 10, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text('Description', 20, yPos + 7);
                doc.text('Qty', 110, yPos + 7);
                doc.text('Rate', 130, yPos + 7);
                doc.text('Amount', 165, yPos + 7);

                // Items
                yPos += 15;
                doc.setTextColor(...darkGray);
                doc.setFont('helvetica', 'normal');

                this.billItems.forEach((item, index) => {
                    const amount = item.quantity * item.rate;
                    
                    // Alternate row background
                    if (index % 2 === 0) {
                        doc.setFillColor(249, 250, 251);
                        doc.rect(15, yPos - 5, 180, 10, 'F');
                    }
                    
                    doc.text(item.description || 'Service', 20, yPos);
                    doc.text(item.quantity.toString(), 115, yPos);
                    doc.text(`₹${item.rate.toFixed(2)}`, 130, yPos);
                    doc.text(`₹${amount.toFixed(2)}`, 165, yPos);
                    
                    yPos += 10;
                });

                // Totals Section
                yPos += 10;
                doc.setDrawColor(...mediumGray);
                doc.line(15, yPos, 195, yPos);
                
                yPos += 10;
                
                // Subtotal
                doc.setFont('helvetica', 'normal');
                doc.text('Subtotal:', 130, yPos);
                doc.text(`₹${subtotal.toFixed(2)}`, 165, yPos);
                
                // Discount
                if (discountPercent > 0) {
                    yPos += 8;
                    doc.setTextColor(...mediumGray);
                    doc.text(`Discount (${discountPercent}%):`, 130, yPos);
                    doc.text(`-₹${discountAmount.toFixed(2)}`, 165, yPos);
                }
                
                // Tax
                if (taxPercent > 0) {
                    yPos += 8;
                    doc.setTextColor(...mediumGray);
                    doc.text(`GST (${taxPercent}%):`, 130, yPos);
                    doc.text(`₹${taxAmount.toFixed(2)}`, 165, yPos);
                }
                
                // Grand Total
                yPos += 12;
                doc.setFillColor(...primaryBlue);
                doc.rect(120, yPos - 6, 75, 12, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(12);
                doc.text('TOTAL:', 130, yPos + 2);
                doc.text(`₹${grandTotal.toFixed(2)}`, 165, yPos + 2);

                // Payment Info
                yPos += 25;
                doc.setTextColor(...darkGray);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text('Payment Information', 20, yPos);
                
                doc.setFont('helvetica', 'normal');
                yPos += 8;
                doc.text(`Method: ${paymentMethod.charAt(0).toUpperCase() + paymentMethod.slice(1)}`, 20, yPos);
                
                const statusColor = paymentStatus === 'paid' ? [16, 185, 129] : 
                                   paymentStatus === 'pending' ? [245, 158, 11] : [99, 102, 241];
                doc.setTextColor(...statusColor);
                doc.text(`Status: ${paymentStatus.toUpperCase()}`, 80, yPos);

                // Notes
                if (notes) {
                    yPos += 15;
                    doc.setTextColor(...darkGray);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Notes:', 20, yPos);
                    doc.setFont('helvetica', 'normal');
                    yPos += 6;
                    
                    const splitNotes = doc.splitTextToSize(notes, 170);
                    doc.text(splitNotes, 20, yPos);
                }

                // Footer
                const pageHeight = doc.internal.pageSize.height;
                doc.setFillColor(249, 250, 251);
                doc.rect(0, pageHeight - 30, 210, 30, 'F');
                
                doc.setTextColor(...mediumGray);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                doc.text('Thank you for choosing Shalom Dental Care!', 105, pageHeight - 20, { align: 'center' });
                doc.text('For appointments: +91 86107 76477 | Email: shalomdentalcare@gmail.com', 105, pageHeight - 12, { align: 'center' });

                if (previewOnly) {
                    // Open PDF in new tab for preview
                    const pdfBlob = doc.output('blob');
                    const pdfUrl = URL.createObjectURL(pdfBlob);
                    window.open(pdfUrl, '_blank');
                    this.showNotification('Bill preview opened in new tab', 'info');
                } else {
                    // Download PDF
                    const fileName = `Shalom-Dental-Bill-${billNumber}-${patientName.replace(/\s+/g, '-')}.pdf`;
                    doc.save(fileName);

                    // Save generated bill record to Supabase
                    await this.saveBillToSupabase(billNumber, discountPercent, taxPercent, grandTotal, paymentMethod, paymentStatus, notes);

                    this.showNotification('Bill PDF downloaded successfully!', 'success');
                }
            }

            // Save generated bill to Supabase
            async saveBillToSupabase(billNumber, discountPercent, taxPercent, grandTotal, paymentMethod, paymentStatus, notes) {
                try {
                    if (typeof supabaseClient === 'undefined' || !supabaseClient || !this.currentBillAppointment) return;

                    const apt = this.currentBillAppointment;
                    const billing = apt.billing || {};

                    const billRecord = {
                        appointment_id: apt.id,
                        bill_number: billNumber,
                        consultant_fee: billing.consultFee || 0,
                        lab_fee: billing.labFee || 0,
                        clinic_fee: billing.clinicFee || 0,
                        total_fee: billing.total || 0,
                        discount_percent: discountPercent || 0,
                        tax_percent: taxPercent || 0,
                        grand_total: grandTotal || 0,
                        payment_method: paymentMethod || 'cash',
                        payment_status: paymentStatus || 'pending',
                        bill_date: new Date().toISOString().split('T')[0],
                        notes: notes || '',
                        bill_generated: true,
                        updated_at: new Date().toISOString(),
                        created_at: new Date().toISOString()
                    };

                    // Use upsert with appointment_id as the conflict target (prevents duplicates)
                    const { error } = await supabaseClient
                        .from('billing')
                        .upsert(billRecord, { onConflict: 'appointment_id' });

                    if (error) throw error;

                    console.log('✅ Bill record saved to Supabase:', billNumber);
                } catch (error) {
                    console.error('Failed to save bill to Supabase:', error);
                }
            }

            // ==================== ANALYTICS METHODS ====================

            // Chart instances
            charts = {};

            // Render Analytics Dashboard
            renderAnalytics() {
                const range = document.getElementById('analyticsRange')?.value || '30';
                const filteredAppointments = this.getFilteredAppointments(range);
                
                this.updateMetricsCards(filteredAppointments, range);
                this.renderAppointmentsChart(filteredAppointments, range);
                this.renderStatusChart(filteredAppointments);
                this.renderServicesChart(filteredAppointments);
                this.renderDaysChart(filteredAppointments);
                this.renderTopServicesList(filteredAppointments);
                this.renderStatusBars(filteredAppointments);
                this.renderRecentActivity();
            }

            // Update Analytics (called from dropdown)
            updateAnalytics() {
                this.renderAnalytics();
            }

            // Get filtered appointments by date range
            getFilteredAppointments(range) {
                if (range === 'all') return this.appointments;
                
                const days = parseInt(range);
                const cutoffDate = new Date();
                cutoffDate.setDate(cutoffDate.getDate() - days);
                
                return this.appointments.filter(apt => {
                    const aptDate = new Date(apt.createdAt || apt.date);
                    return aptDate >= cutoffDate;
                });
            }

            // Get previous period appointments for comparison
            getPreviousPeriodAppointments(range) {
                if (range === 'all') return [];
                
                const days = parseInt(range);
                const startDate = new Date();
                startDate.setDate(startDate.getDate() - (days * 2));
                const endDate = new Date();
                endDate.setDate(endDate.getDate() - days);
                
                return this.appointments.filter(apt => {
                    const aptDate = new Date(apt.createdAt || apt.date);
                    return aptDate >= startDate && aptDate < endDate;
                });
            }

            // Update Metrics Cards
            updateMetricsCards(appointments, range) {
                const previousAppointments = this.getPreviousPeriodAppointments(range);
                
                // Revenue calculation (estimate based on services)
                const revenue = appointments.reduce((sum, apt) => {
                    return sum + this.getServicePrice(apt.service);
                }, 0);
                const prevRevenue = previousAppointments.reduce((sum, apt) => {
                    return sum + this.getServicePrice(apt.service);
                }, 0);
                
                document.getElementById('analyticsRevenue').textContent = `₹${revenue.toLocaleString('en-IN')}`;
                this.updateTrend('revenueTrend', revenue, prevRevenue);
                
                // Total appointments
                document.getElementById('analyticsAppointments').textContent = appointments.length;
                this.updateTrend('appointmentsTrend', appointments.length, previousAppointments.length);
                
                // Unique patients (by phone)
                const uniquePatients = new Set(appointments.map(a => a.phone)).size;
                const prevUniquePatients = new Set(previousAppointments.map(a => a.phone)).size;
                document.getElementById('analyticsPatients').textContent = uniquePatients;
                this.updateTrend('patientsTrend', uniquePatients, prevUniquePatients);
                
                // Completion rate
                const completed = appointments.filter(a => a.status === 'completed').length;
                const total = appointments.length;
                const completionRate = total > 0 ? Math.round((completed / total) * 100) : 0;
                
                const prevCompleted = previousAppointments.filter(a => a.status === 'completed').length;
                const prevTotal = previousAppointments.length;
                const prevCompletionRate = prevTotal > 0 ? Math.round((prevCompleted / prevTotal) * 100) : 0;
                
                document.getElementById('analyticsCompletionRate').textContent = `${completionRate}%`;
                this.updateTrend('completionTrend', completionRate, prevCompletionRate);
            }

            // Update trend indicator
            updateTrend(elementId, current, previous) {
                const element = document.getElementById(elementId);
                if (!element) return;
                
                let percentChange = 0;
                if (previous > 0) {
                    percentChange = Math.round(((current - previous) / previous) * 100);
                } else if (current > 0) {
                    percentChange = 100;
                }
                
                const isUp = percentChange >= 0;
                element.innerHTML = `
                    <i class="fas fa-arrow-${isUp ? 'up' : 'down'}"></i>
                    <span>${isUp ? '+' : ''}${percentChange}% from last period</span>
                `;
            }

            // Render Appointments Over Time Chart
            renderAppointmentsChart(appointments, range) {
                const ctx = document.getElementById('appointmentsChart');
                if (!ctx) return;
                
                // Destroy existing chart
                if (this.charts.appointments) {
                    this.charts.appointments.destroy();
                }
                
                // Group appointments by date
                const dateGroups = {};
                const days = range === 'all' ? 365 : parseInt(range);
                
                // Initialize dates
                for (let i = days - 1; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    const dateStr = date.toISOString().split('T')[0];
                    dateGroups[dateStr] = { total: 0, completed: 0, cancelled: 0 };
                }
                
                // Count appointments
                appointments.forEach(apt => {
                    const dateStr = apt.date;
                    if (dateGroups[dateStr]) {
                        dateGroups[dateStr].total++;
                        if (apt.status === 'completed') dateGroups[dateStr].completed++;
                        if (apt.status === 'cancelled') dateGroups[dateStr].cancelled++;
                    }
                });
                
                // Prepare data for chart (aggregate by week if large range)
                let labels, data, completedData;
                
                if (days > 60) {
                    // Aggregate by week
                    const weekGroups = {};
                    Object.keys(dateGroups).forEach(dateStr => {
                        const date = new Date(dateStr);
                        const weekStart = new Date(date);
                        weekStart.setDate(date.getDate() - date.getDay());
                        const weekKey = weekStart.toISOString().split('T')[0];
                        
                        if (!weekGroups[weekKey]) {
                            weekGroups[weekKey] = { total: 0, completed: 0 };
                        }
                        weekGroups[weekKey].total += dateGroups[dateStr].total;
                        weekGroups[weekKey].completed += dateGroups[dateStr].completed;
                    });
                    
                    labels = Object.keys(weekGroups).slice(-12).map(d => {
                        const date = new Date(d);
                        return date.toLocaleDateString('en-IN', { month: 'short', day: 'numeric' });
                    });
                    data = Object.values(weekGroups).slice(-12).map(w => w.total);
                    completedData = Object.values(weekGroups).slice(-12).map(w => w.completed);
                } else {
                    labels = Object.keys(dateGroups).slice(-days).map(d => {
                        const date = new Date(d);
                        return date.toLocaleDateString('en-IN', { month: 'short', day: 'numeric' });
                    });
                    data = Object.values(dateGroups).slice(-days).map(d => d.total);
                    completedData = Object.values(dateGroups).slice(-days).map(d => d.completed);
                }
                
                this.charts.appointments = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Total Appointments',
                                data: data,
                                borderColor: '#3b82f6',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                fill: true,
                                tension: 0.4
                            },
                            {
                                label: 'Completed',
                                data: completedData,
                                borderColor: '#10b981',
                                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                fill: true,
                                tension: 0.4
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        }
                    }
                });
            }

            // Render Status Distribution Chart
            renderStatusChart(appointments) {
                const ctx = document.getElementById('statusChart');
                if (!ctx) return;
                
                if (this.charts.status) {
                    this.charts.status.destroy();
                }
                
                const statusCounts = {
                    pending: 0,
                    confirmed: 0,
                    completed: 0,
                    cancelled: 0
                };
                
                appointments.forEach(apt => {
                    if (statusCounts.hasOwnProperty(apt.status)) {
                        statusCounts[apt.status]++;
                    }
                });
                
                this.charts.status = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Pending', 'Confirmed', 'Completed', 'Cancelled'],
                        datasets: [{
                            data: [statusCounts.pending, statusCounts.confirmed, statusCounts.completed, statusCounts.cancelled],
                            backgroundColor: ['#f59e0b', '#10b981', '#6366f1', '#ef4444'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right'
                            }
                        },
                        cutout: '60%'
                    }
                });
            }

            // Render Services Chart
            renderServicesChart(appointments) {
                const ctx = document.getElementById('servicesChart');
                if (!ctx) return;
                
                if (this.charts.services) {
                    this.charts.services.destroy();
                }
                
                const serviceCounts = {};
                appointments.forEach(apt => {
                    const service = apt.service || 'Other';
                    serviceCounts[service] = (serviceCounts[service] || 0) + 1;
                });
                
                const sortedServices = Object.entries(serviceCounts)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 6);
                
                this.charts.services = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: sortedServices.map(s => s[0]),
                        datasets: [{
                            label: 'Appointments',
                            data: sortedServices.map(s => s[1]),
                            backgroundColor: [
                                '#3b82f6', '#10b981', '#f59e0b', '#6366f1', '#ec4899', '#8b5cf6'
                            ],
                            borderRadius: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        }
                    }
                });
            }

            // Render Days of Week Chart
            renderDaysChart(appointments) {
                const ctx = document.getElementById('daysChart');
                if (!ctx) return;
                
                if (this.charts.days) {
                    this.charts.days.destroy();
                }
                
                const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                const dayCounts = [0, 0, 0, 0, 0, 0, 0];
                
                appointments.forEach(apt => {
                    const date = new Date(apt.date);
                    const dayIndex = date.getDay();
                    dayCounts[dayIndex]++;
                });
                
                this.charts.days = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: dayNames,
                        datasets: [{
                            label: 'Appointments',
                            data: dayCounts,
                            backgroundColor: '#8b5cf6',
                            borderRadius: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        }
                    }
                });
            }

            // Render Top Services List
            renderTopServicesList(appointments) {
                const container = document.getElementById('topServicesList');
                if (!container) return;
                
                const serviceCounts = {};
                appointments.forEach(apt => {
                    const service = apt.service || 'Other';
                    serviceCounts[service] = (serviceCounts[service] || 0) + 1;
                });
                
                const sortedServices = Object.entries(serviceCounts)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5);
                
                if (sortedServices.length === 0) {
                    container.innerHTML = '<li style="text-align: center; color: #9ca3af; padding: 2rem;">No data available</li>';
                    return;
                }
                
                container.innerHTML = sortedServices.map((service, index) => `
                    <li>
                        <div class="service-info">
                            <span class="service-rank">${index + 1}</span>
                            <span class="service-name">${service[0]}</span>
                        </div>
                        <span class="service-count">${service[1]} appointments</span>
                    </li>
                `).join('');
            }

            // Render Status Bars
            renderStatusBars(appointments) {
                const container = document.getElementById('statusBars');
                if (!container) return;
                
                const total = appointments.length;
                if (total === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #9ca3af; padding: 2rem;">No data available</p>';
                    return;
                }
                
                const statuses = [
                    { key: 'pending', label: 'Pending', color: 'pending' },
                    { key: 'confirmed', label: 'Confirmed', color: 'confirmed' },
                    { key: 'completed', label: 'Completed', color: 'completed' },
                    { key: 'cancelled', label: 'Cancelled', color: 'cancelled' }
                ];
                
                container.innerHTML = statuses.map(status => {
                    const count = appointments.filter(a => a.status === status.key).length;
                    const percentage = Math.round((count / total) * 100);
                    
                    return `
                        <div class="status-bar-item">
                            <div class="status-bar-header">
                                <span class="status-bar-label">${status.label}</span>
                                <span class="status-bar-value">${count} (${percentage}%)</span>
                            </div>
                            <div class="status-bar-track">
                                <div class="status-bar-fill ${status.color}" style="width: ${percentage}%"></div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // Render Recent Activity
            renderRecentActivity() {
                const container = document.getElementById('recentActivityList');
                if (!container) return;
                
                const recentAppointments = this.appointments
                    .slice()
                    .sort((a, b) => new Date(b.updatedAt || b.createdAt) - new Date(a.updatedAt || a.createdAt))
                    .slice(0, 10);
                
                if (recentAppointments.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #9ca3af; padding: 2rem;">No recent activity</p>';
                    return;
                }
                
                const getActivityIcon = (status) => {
                    switch(status) {
                        case 'pending': return { class: 'new', icon: 'fa-plus' };
                        case 'confirmed': return { class: 'confirmed', icon: 'fa-check' };
                        case 'completed': return { class: 'completed', icon: 'fa-check-double' };
                        case 'cancelled': return { class: 'cancelled', icon: 'fa-times' };
                        default: return { class: 'new', icon: 'fa-calendar' };
                    }
                };
                
                const getActivityTitle = (apt) => {
                    switch(apt.status) {
                        case 'pending': return `New appointment from ${apt.name}`;
                        case 'confirmed': return `Appointment confirmed for ${apt.name}`;
                        case 'completed': return `Appointment completed for ${apt.name}`;
                        case 'cancelled': return `Appointment cancelled for ${apt.name}`;
                        default: return `Appointment update for ${apt.name}`;
                    }
                };
                
                const formatTimeAgo = (dateStr) => {
                    const date = new Date(dateStr);
                    const now = new Date();
                    const diffMs = now - date;
                    const diffMins = Math.floor(diffMs / 60000);
                    const diffHours = Math.floor(diffMs / 3600000);
                    const diffDays = Math.floor(diffMs / 86400000);
                    
                    if (diffMins < 1) return 'Just now';
                    if (diffMins < 60) return `${diffMins} min ago`;
                    if (diffHours < 24) return `${diffHours} hours ago`;
                    if (diffDays < 7) return `${diffDays} days ago`;
                    return date.toLocaleDateString('en-IN');
                };
                
                container.innerHTML = recentAppointments.map(apt => {
                    const iconInfo = getActivityIcon(apt.status);
                    return `
                        <div class="activity-item">
                            <div class="activity-icon ${iconInfo.class}">
                                <i class="fas ${iconInfo.icon}"></i>
                            </div>
                            <div class="activity-content">
                                <div class="activity-title">${getActivityTitle(apt)}</div>
                                <div class="activity-time">
                                    <i class="fas fa-clock"></i> ${formatTimeAgo(apt.updatedAt || apt.createdAt)}
                                    • ${apt.service}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // ==================== FEEDBACK MANAGEMENT METHODS ====================

            // Feedback data storage
            feedbackList = [];

            // Supabase feedback manager instance
            feedbackManager = null;

            // Initialize feedback manager
            initFeedbackManager() {
                if (window.SupabaseFeedbackManager) {
                    this.feedbackManager = new SupabaseFeedbackManager();
                    console.log('✅ Supabase Feedback Manager initialized, connected:', this.feedbackManager.isConnected);
                }
            }

            // Load feedback from Supabase first, then localStorage as fallback
            async loadFeedback() {
                // Initialize feedback manager if not yet done
                if (!this.feedbackManager) {
                    this.initFeedbackManager();
                }

                // Try Supabase first
                if (this.feedbackManager && this.feedbackManager.isConnected) {
                    try {
                        const supabaseData = await this.feedbackManager.loadAllFeedback();
                        if (supabaseData && supabaseData.length > 0) {
                            // Convert Supabase format to local format
                            this.feedbackList = supabaseData.map(fb => ({
                                id: fb.id,
                                appointmentId: fb.appointment_id,
                                patientName: fb.patient_name,
                                phone: fb.phone,
                                service: fb.service,
                                appointmentDate: fb.appointment_date,
                                rating: fb.rating,
                                categories: fb.categories || [],
                                comments: fb.comments,
                                recommend: fb.recommend,
                                source: fb.source,
                                internalNotes: fb.internal_notes,
                                showOnHomepage: fb.show_on_homepage,
                                createdAt: fb.created_at,
                                createdBy: fb.created_by
                            }));
                            // Also save to localStorage as cache
                            localStorage.setItem('dentalFeedback', JSON.stringify(this.feedbackList));
                            console.log(`✅ Loaded ${this.feedbackList.length} feedback from Supabase`);
                            return;
                        }
                    } catch (e) {
                        console.error('Supabase feedback load failed, falling back to localStorage:', e);
                    }
                }

                // Fallback: localStorage
                try {
                    const stored = localStorage.getItem('dentalFeedback');
                    if (stored) {
                        this.feedbackList = JSON.parse(stored);
                    }
                } catch (e) {
                    console.error('Failed to load feedback:', e);
                    this.feedbackList = [];
                }
            }

            // Save feedback to localStorage AND Supabase
            saveFeedback() {
                try {
                    localStorage.setItem('dentalFeedback', JSON.stringify(this.feedbackList));
                } catch (e) {
                    console.error('Failed to save feedback:', e);
                }
            }

            // Save single feedback entry to Supabase
            async saveFeedbackToSupabase(feedback) {
                if (!this.feedbackManager) {
                    this.initFeedbackManager();
                }
                if (this.feedbackManager && this.feedbackManager.isConnected) {
                    try {
                        const result = await this.feedbackManager.saveFeedback(feedback);
                        if (result) {
                            // Update the local ID with the Supabase ID
                            const localEntry = this.feedbackList.find(f => f.id === feedback.id);
                            if (localEntry) {
                                localEntry.id = result.id;
                                this.saveFeedback(); // Update localStorage with new ID
                            }
                            console.log('✅ Feedback synced to Supabase cloud');
                            return result;
                        }
                    } catch (e) {
                        console.error('Failed to save feedback to Supabase:', e);
                    }
                }
                return null;
            }

            // Render Feedback View
            renderFeedbackView() {
                this.loadFeedback();
                this.populateAppointmentDropdown();
                this.updateFeedbackStats();
                this.renderFeedbackList();
                this.setupCategoryTags();
            }

            // Setup category tag click handlers
            setupCategoryTags() {
                document.querySelectorAll('.category-tag').forEach(tag => {
                    tag.addEventListener('click', function(e) {
                        e.preventDefault();
                        this.classList.toggle('selected');
                        // Also toggle the checkbox inside
                        const checkbox = this.querySelector('input[type="checkbox"]');
                        if (checkbox) {
                            checkbox.checked = this.classList.contains('selected');
                        }
                    });
                });
            }

            // Populate appointment dropdown with recent appointments
            populateAppointmentDropdown() {
                const select = document.getElementById('feedbackAppointment');
                if (!select) return;

                // Get completed and confirmed appointments
                const eligibleAppointments = this.appointments
                    .filter(apt => apt.status === 'completed' || apt.status === 'confirmed')
                    .sort((a, b) => new Date(b.date) - new Date(a.date))
                    .slice(0, 50); // Last 50 appointments

                select.innerHTML = '<option value="">-- Select a patient/appointment --</option>';
                
                eligibleAppointments.forEach(apt => {
                    const option = document.createElement('option');
                    option.value = apt.id;
                    option.dataset.name = apt.name;
                    option.dataset.phone = apt.phone;
                    option.textContent = `${apt.name} - ${apt.service} (${new Date(apt.date).toLocaleDateString('en-IN')})`;
                    select.appendChild(option);
                });

                // Update patient details when selection changes
                select.addEventListener('change', (e) => {
                    const selectedOption = e.target.options[e.target.selectedIndex];
                    if (selectedOption.value) {
                        document.getElementById('feedbackPatientName').value = selectedOption.dataset.name || '';
                        document.getElementById('feedbackPhone').value = selectedOption.dataset.phone || '';
                    }
                });
            }

            // Update feedback statistics
            updateFeedbackStats() {
                const totalFeedback = this.feedbackList.length;
                const avgRating = totalFeedback > 0 
                    ? (this.feedbackList.reduce((sum, f) => sum + f.rating, 0) / totalFeedback).toFixed(1)
                    : '0.0';
                const positiveFeedback = this.feedbackList.filter(f => f.rating >= 4).length;
                const negativeFeedback = this.feedbackList.filter(f => f.rating <= 2).length;

                document.getElementById('totalFeedbackCount').textContent = totalFeedback;
                document.getElementById('avgRating').textContent = avgRating;
                document.getElementById('positiveFeedbackCount').textContent = positiveFeedback;
                document.getElementById('negativeFeedbackCount').textContent = negativeFeedback;
                document.getElementById('feedbackListCount').textContent = `${totalFeedback} entries`;

                // Update badge count on the quick action button
                const badge = document.getElementById('feedbackBadgeCount');
                if (badge) badge.textContent = totalFeedback;
            }

            // Switch feedback tab
            switchFeedbackTab(tab, element) {
                document.querySelectorAll('.feedback-tab').forEach(t => t.classList.remove('active'));
                element.classList.add('active');

                const entrySection = document.getElementById('feedbackEntrySection');
                const listSection = document.getElementById('feedbackListSection');

                if (tab === 'entry') {
                    entrySection.style.display = 'block';
                    listSection.style.display = 'block';
                } else {
                    entrySection.style.display = 'none';
                    listSection.style.display = 'block';
                    listSection.style.gridColumn = '1 / -1';
                }
            }

            // Submit feedback
            submitFeedback(event) {
                event.preventDefault();

                const appointmentId = document.getElementById('feedbackAppointment').value;
                const patientName = document.getElementById('feedbackPatientName').value;
                const phone = document.getElementById('feedbackPhone').value;
                const ratingInput = document.querySelector('input[name="rating"]:checked');
                const rating = ratingInput ? parseInt(ratingInput.value) : 0;
                const categories = Array.from(document.querySelectorAll('.category-tag.selected input'))
                    .map(input => input.value);
                const comments = document.getElementById('feedbackComments').value;
                const recommend = document.getElementById('feedbackRecommend').value;
                const source = document.getElementById('feedbackSource').value;
                const internalNotes = document.getElementById('feedbackInternalNotes').value;
                const showOnHomepage = document.getElementById('feedbackShowOnHomepage').checked;

                // Validation
                if (!patientName && !appointmentId) {
                    this.showNotification('Please select an appointment or enter patient name', 'error');
                    return;
                }

                if (rating === 0) {
                    this.showNotification('Please select a rating', 'error');
                    return;
                }

                // Warning if trying to show low rating on homepage
                if (showOnHomepage && rating < 4) {
                    this.showNotification('Only ratings 4★ and above can be shown on homepage', 'warning');
                    document.getElementById('feedbackShowOnHomepage').checked = false;
                    return;
                }

                // Get appointment details if selected
                let appointment = null;
                if (appointmentId) {
                    appointment = this.appointments.find(a => a.id == appointmentId);
                }

                // Create feedback object
                const feedback = {
                    id: Date.now(),
                    appointmentId: appointmentId || null,
                    patientName: patientName || (appointment ? appointment.name : 'Unknown'),
                    phone: phone || (appointment ? appointment.phone : ''),
                    service: appointment ? appointment.service : 'General',
                    appointmentDate: appointment ? appointment.date : new Date().toISOString().split('T')[0],
                    rating: rating,
                    categories: categories,
                    comments: comments,
                    recommend: recommend,
                    source: source,
                    internalNotes: internalNotes,
                    showOnHomepage: showOnHomepage && rating >= 4,
                    createdAt: new Date().toISOString(),
                    createdBy: 'Admin'
                };

                // Add to feedback list
                this.feedbackList.unshift(feedback);
                this.saveFeedback();

                // Also save to Supabase for cross-device persistence
                this.saveFeedbackToSupabase(feedback);

                // Update UI
                this.updateFeedbackStats();
                this.renderFeedbackList();
                this.clearFeedbackForm();

                this.showNotification('Feedback saved successfully!', 'success');
            }

            // Clear feedback form
            clearFeedbackForm() {
                document.getElementById('feedbackForm').reset();
                document.getElementById('feedbackPatientName').value = '';
                document.getElementById('feedbackPhone').value = '';
                document.getElementById('feedbackShowOnHomepage').checked = false;
                document.querySelectorAll('.category-tag').forEach(tag => {
                    tag.classList.remove('selected');
                    const checkbox = tag.querySelector('input[type="checkbox"]');
                    if (checkbox) checkbox.checked = false;
                });
                document.querySelectorAll('input[name="rating"]').forEach(input => input.checked = false);
            }

            // Render feedback list
            renderFeedbackList() {
                const container = document.getElementById('feedbackListContainer');
                if (!container) return;

                if (this.feedbackList.length === 0) {
                    container.innerHTML = `
                        <div class="empty-feedback">
                            <i class="fas fa-comment-slash"></i>
                            <h3>No feedback yet</h3>
                            <p>Start by adding patient feedback using the form</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = this.feedbackList.map(feedback => {
                    const stars = this.generateStarRating(feedback.rating);
                    const categoryTags = feedback.categories.map(cat => 
                        `<span class="feedback-category-tag">${this.getCategoryLabel(cat)}</span>`
                    ).join('');
                    const homepageBadge = feedback.showOnHomepage ? 
                        `<span class="homepage-badge"><i class="fas fa-globe"></i> On Website</span>` : '';
                    
                    return `
                        <div class="feedback-item rating-${feedback.rating}">
                            <div class="feedback-item-header">
                                <div class="feedback-patient-info">
                                    <h4>${feedback.patientName} ${homepageBadge}</h4>
                                    <div class="appointment-ref">
                                        ${feedback.service} • ${new Date(feedback.appointmentDate).toLocaleDateString('en-IN')}
                                    </div>
                                </div>
                                <div class="feedback-rating">
                                    ${stars}
                                </div>
                            </div>
                            ${categoryTags ? `<div class="feedback-categories">${categoryTags}</div>` : ''}
                            ${feedback.comments ? `<div class="feedback-comment">"${feedback.comments}"</div>` : ''}
                            <div class="feedback-meta">
                                <span>
                                    <i class="fas fa-${this.getSourceIcon(feedback.source)}"></i>
                                    ${this.getSourceLabel(feedback.source)} • 
                                    ${new Date(feedback.createdAt).toLocaleDateString('en-IN')}
                                </span>
                                <div class="feedback-actions">
                                    <button class="feedback-action-btn ${feedback.showOnHomepage ? 'homepage-active' : 'homepage'}" 
                                            onclick="adminPortal.toggleHomepageDisplay(${feedback.id})" 
                                            title="${feedback.showOnHomepage ? 'Remove from Website' : 'Show on Website'}">
                                        <i class="fas fa-globe"></i>
                                    </button>
                                    <button class="feedback-action-btn export" onclick="adminPortal.exportSingleFeedback(${feedback.id})" title="Export">
                                        <i class="fas fa-download"></i>
                                    </button>
                                    <button class="feedback-action-btn delete" onclick="adminPortal.deleteFeedback(${feedback.id})" title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // Generate star rating HTML
            generateStarRating(rating) {
                let stars = '';
                for (let i = 1; i <= 5; i++) {
                    stars += `<i class="fas fa-star ${i > rating ? 'empty' : ''}"></i>`;
                }
                return stars;
            }

            // Get category label
            getCategoryLabel(category) {
                const labels = {
                    'cleanliness': '🧹 Cleanliness',
                    'staff': '👨‍⚕️ Staff',
                    'treatment': '🦷 Treatment',
                    'wait-time': '⏱️ Wait Time',
                    'pricing': '💰 Pricing',
                    'facilities': '🏥 Facilities',
                    'communication': '💬 Communication',
                    'followup': '📞 Follow-up'
                };
                return labels[category] || category;
            }

            // Get source icon
            getSourceIcon(source) {
                const icons = {
                    'in-person': 'user',
                    'phone': 'phone',
                    'whatsapp': 'whatsapp',
                    'email': 'envelope',
                    'google': 'google',
                    'social': 'share-alt',
                    'other': 'comment'
                };
                return icons[source] || 'comment';
            }

            // Get source label
            getSourceLabel(source) {
                const labels = {
                    'in-person': 'In-Person',
                    'phone': 'Phone',
                    'whatsapp': 'WhatsApp',
                    'email': 'Email',
                    'google': 'Google Review',
                    'social': 'Social Media',
                    'other': 'Other'
                };
                return labels[source] || source;
            }

            // Toggle homepage display for feedback
            toggleHomepageDisplay(id) {
                const feedback = this.feedbackList.find(f => f.id === id);
                if (!feedback) return;

                // Only allow showing 4+ star ratings on homepage
                if (!feedback.showOnHomepage && feedback.rating < 4) {
                    this.showNotification('Only 4★ and above ratings can be shown on website', 'warning');
                    return;
                }

                feedback.showOnHomepage = !feedback.showOnHomepage;
                this.saveFeedback();
                this.renderFeedbackList();
                
                const message = feedback.showOnHomepage ? 
                    'Feedback will now appear on website' : 
                    'Feedback removed from website display';
                this.showNotification(message, 'success');
            }

            // Delete feedback
            deleteFeedback(id) {
                if (!confirm('Are you sure you want to delete this feedback?')) return;

                this.feedbackList = this.feedbackList.filter(f => f.id !== id);
                this.saveFeedback();
                this.updateFeedbackStats();
                this.renderFeedbackList();
                this.showNotification('Feedback deleted', 'info');
            }

            // Export single feedback
            exportSingleFeedback(id) {
                const feedback = this.feedbackList.find(f => f.id === id);
                if (!feedback) return;

                const content = `
PATIENT FEEDBACK REPORT
=======================
Generated: ${new Date().toLocaleString()}

Patient: ${feedback.patientName}
Phone: ${feedback.phone}
Service: ${feedback.service}
Appointment Date: ${new Date(feedback.appointmentDate).toLocaleDateString('en-IN')}

Rating: ${'★'.repeat(feedback.rating)}${'☆'.repeat(5 - feedback.rating)} (${feedback.rating}/5)

Categories: ${feedback.categories.map(c => this.getCategoryLabel(c)).join(', ') || 'None'}

Comments:
${feedback.comments || 'No comments provided'}

Would Recommend: ${feedback.recommend || 'Not specified'}
Feedback Source: ${this.getSourceLabel(feedback.source)}

Internal Notes:
${feedback.internalNotes || 'None'}

---
Shalom Dental Care
                `.trim();

                const blob = new Blob([content], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `feedback-${feedback.patientName.replace(/\s+/g, '-')}-${feedback.id}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                this.showNotification('Feedback exported!', 'success');
            }

            // Export all feedback as CSV
            exportAllFeedback() {
                if (this.feedbackList.length === 0) {
                    this.showNotification('No feedback to export', 'error');
                    return;
                }

                const headers = ['Date', 'Patient', 'Phone', 'Service', 'Rating', 'Categories', 'Comments', 'Recommend', 'Source'];
                const rows = this.feedbackList.map(f => [
                    new Date(f.createdAt).toLocaleDateString('en-IN'),
                    `"${f.patientName}"`,
                    f.phone,
                    `"${f.service}"`,
                    f.rating,
                    `"${f.categories.join(', ')}"`,
                    `"${(f.comments || '').replace(/"/g, '""')}"`,
                    f.recommend,
                    f.source
                ]);

                const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `shalom-dental-feedback-${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                this.showNotification('All feedback exported!', 'success');
            }

            // Open Quick Feedback Modal from appointment card
            openQuickFeedback(appointmentId) {
                const appointment = this.appointments.find(a => a.id === appointmentId);
                if (!appointment) {
                    this.showNotification('Appointment not found', 'error');
                    return;
                }

                // Remove existing dialog if any
                const existingDialog = document.getElementById('quickFeedbackDialog');
                if (existingDialog) existingDialog.remove();

                const dialog = document.createElement('div');
                dialog.id = 'quickFeedbackDialog';
                dialog.innerHTML = `
                    <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); z-index: 2000; display: flex; justify-content: center; align-items: center; padding: 1rem;">
                        <div style="background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 20px; max-width: 500px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 80px rgba(0,0,0,0.25);">
                            <div style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.9), rgba(217, 119, 6, 0.95)); color: white; padding: 1.5rem 2rem; border-radius: 20px 20px 0 0; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                <h3 style="display: flex; align-items: center; gap: 0.75rem; font-size: 1.2rem; margin: 0;">
                                    <i class="fas fa-comment-dots"></i> Quick Feedback
                                </h3>
                                <button onclick="document.getElementById('quickFeedbackDialog').remove()" style="background: rgba(255,255,255,0.2); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.3); color: white; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 1.2rem;">×</button>
                            </div>
                            <div style="padding: 1.5rem; background: rgba(255,255,255,0.3);">
                                <div style="background: rgba(254, 243, 199, 0.8); backdrop-filter: blur(10px); padding: 1rem; border-radius: 12px; margin-bottom: 1.5rem; border: 1px solid rgba(245, 158, 11, 0.2);">
                                    <div style="font-size: 0.9rem; color: #92400e;">
                                        <div><strong>Patient:</strong> ${appointment.name}</div>
                                        <div><strong>Service:</strong> ${appointment.service}</div>
                                        <div><strong>Date:</strong> ${new Date(appointment.date).toLocaleDateString('en-IN')}</div>
                                    </div>
                                </div>

                                <div style="margin-bottom: 1.25rem;">
                                    <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">
                                        <i class="fas fa-star" style="color: #f59e0b;"></i> Rating
                                    </label>
                                    <div id="quickStarRating" style="display: flex; gap: 0.5rem;">
                                        ${[1,2,3,4,5].map(i => `
                                            <span class="quick-star" data-rating="${i}" onclick="adminPortal.setQuickRating(${i})" 
                                                  style="font-size: 2rem; color: rgba(209, 213, 219, 0.8); cursor: pointer; transition: all 0.2s; text-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                                <i class="fas fa-star"></i>
                                            </span>
                                        `).join('')}
                                    </div>
                                    <input type="hidden" id="quickRatingValue" value="0">
                                </div>

                                <div style="margin-bottom: 1.25rem;">
                                    <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">
                                        <i class="fas fa-comment-alt" style="color: #f59e0b;"></i> Quick Comments
                                    </label>
                                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 0.75rem;">
                                        <button type="button" onclick="adminPortal.addQuickComment('Very satisfied with the service')" 
                                                style="padding: 0.5rem 0.75rem; background: rgba(254, 243, 199, 0.8); backdrop-filter: blur(10px); border: 1px solid rgba(245, 158, 11, 0.4); border-radius: 20px; cursor: pointer; font-size: 0.8rem; transition: all 0.3s;">
                                            😊 Very satisfied
                                        </button>
                                        <button type="button" onclick="adminPortal.addQuickComment('Doctor was friendly and professional')" 
                                                style="padding: 0.5rem 0.75rem; background: rgba(254, 243, 199, 0.8); backdrop-filter: blur(10px); border: 1px solid rgba(245, 158, 11, 0.4); border-radius: 20px; cursor: pointer; font-size: 0.8rem; transition: all 0.3s;">
                                            👨‍⚕️ Great doctor
                                        </button>
                                        <button type="button" onclick="adminPortal.addQuickComment('Clean and hygienic clinic')" 
                                                style="padding: 0.5rem 0.75rem; background: rgba(254, 243, 199, 0.8); backdrop-filter: blur(10px); border: 1px solid rgba(245, 158, 11, 0.4); border-radius: 20px; cursor: pointer; font-size: 0.8rem; transition: all 0.3s;">
                                            🧹 Very clean
                                        </button>
                                        <button type="button" onclick="adminPortal.addQuickComment('Minimal wait time')" 
                                                style="padding: 0.5rem 0.75rem; background: rgba(254, 243, 199, 0.8); backdrop-filter: blur(10px); border: 1px solid rgba(245, 158, 11, 0.4); border-radius: 20px; cursor: pointer; font-size: 0.8rem; transition: all 0.3s;">
                                            ⏱️ Quick service
                                        </button>
                                        <button type="button" onclick="adminPortal.addQuickComment('Will recommend to others')" 
                                                style="padding: 0.5rem 0.75rem; background: rgba(254, 243, 199, 0.8); backdrop-filter: blur(10px); border: 1px solid rgba(245, 158, 11, 0.4); border-radius: 20px; cursor: pointer; font-size: 0.8rem; transition: all 0.3s;">
                                            👍 Will recommend
                                        </button>
                                    </div>
                                    <textarea id="quickFeedbackComments" rows="3" placeholder="Enter feedback comments..." 
                                              style="width: 100%; padding: 0.75rem; background: rgba(255,255,255,0.7); backdrop-filter: blur(10px); border: 1px solid rgba(229, 231, 235, 0.8); border-radius: 12px; font-size: 0.95rem; resize: vertical;"></textarea>
                                </div>

                                <div style="display: flex; gap: 1rem; justify-content: flex-end; padding-top: 1rem; border-top: 1px solid rgba(229, 231, 235, 0.5);">
                                    <button onclick="document.getElementById('quickFeedbackDialog').remove()" 
                                            style="padding: 0.75rem 1.5rem; background: rgba(243, 244, 246, 0.8); backdrop-filter: blur(10px); border: 1px solid rgba(0,0,0,0.1); border-radius: 10px; cursor: pointer; font-weight: 500; color: #374151;">
                                        Cancel
                                    </button>
                                    <button onclick="adminPortal.saveQuickFeedback(${appointmentId})" 
                                            style="padding: 0.75rem 1.5rem; background: linear-gradient(135deg, rgba(245, 158, 11, 0.9), rgba(217, 119, 6, 0.95)); color: white; border: 1px solid rgba(245, 158, 11, 0.3); border-radius: 10px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 0.5rem; box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);">
                                        <i class="fas fa-save"></i> Save Feedback
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(dialog);
            }

            // Set quick rating
            setQuickRating(rating) {
                document.getElementById('quickRatingValue').value = rating;
                document.querySelectorAll('#quickStarRating .quick-star').forEach((star, index) => {
                    star.style.color = index < rating ? '#fbbf24' : '#d1d5db';
                });
            }

            // Add quick comment
            addQuickComment(comment) {
                const textarea = document.getElementById('quickFeedbackComments');
                if (textarea.value) {
                    textarea.value += '. ' + comment;
                } else {
                    textarea.value = comment;
                }
            }

            // Save quick feedback
            saveQuickFeedback(appointmentId) {
                const appointment = this.appointments.find(a => a.id === appointmentId);
                if (!appointment) return;

                const rating = parseInt(document.getElementById('quickRatingValue').value);
                const comments = document.getElementById('quickFeedbackComments').value;

                if (rating === 0) {
                    this.showNotification('Please select a rating', 'error');
                    return;
                }

                // Create feedback object
                const feedback = {
                    id: Date.now(),
                    appointmentId: appointmentId,
                    patientName: appointment.name,
                    phone: appointment.phone,
                    service: appointment.service,
                    appointmentDate: appointment.date,
                    rating: rating,
                    categories: [],
                    comments: comments,
                    recommend: rating >= 4 ? 'yes' : (rating >= 3 ? 'maybe' : 'no'),
                    source: 'in-person',
                    internalNotes: '',
                    createdAt: new Date().toISOString(),
                    createdBy: 'Admin (Quick Entry)'
                };

                // Load existing feedback and add new one
                this.loadFeedback();
                this.feedbackList.unshift(feedback);
                this.saveFeedback();

                // Close dialog
                document.getElementById('quickFeedbackDialog').remove();
                this.showNotification('Feedback saved successfully!', 'success');
            }
        }

        // Initialize
        const adminPortal = new AdminPortal();
        document.addEventListener('DOMContentLoaded', () => adminPortal.init());

        // Close modal on overlay click
        document.getElementById('dayModal').addEventListener('click', function(e) {
            if (e.target === this) {
                adminPortal.closeModal();
            }
        });

        // Close bill modal on overlay click
        document.getElementById('billModal').addEventListener('click', function(e) {
            if (e.target === this) {
                adminPortal.closeBillModal();
            }
        });
    </script>
</body>
</html>
